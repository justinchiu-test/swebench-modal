[{"repo": "django/django", "instance_id": "django__django-13933", "base_commit": "42e8cf47c7ee2db238bf91197ea398126c546741", "patch": "diff --git a/django/forms/models.py b/django/forms/models.py\n--- a/django/forms/models.py\n+++ b/django/forms/models.py\n@@ -1284,7 +1284,11 @@ def to_python(self, value):\n                 value = getattr(value, key)\n             value = self.queryset.get(**{key: value})\n         except (ValueError, TypeError, self.queryset.model.DoesNotExist):\n-            raise ValidationError(self.error_messages['invalid_choice'], code='invalid_choice')\n+            raise ValidationError(\n+                self.error_messages['invalid_choice'],\n+                code='invalid_choice',\n+                params={'value': value},\n+            )\n         return value\n \n     def validate(self, value):\n", "test_patch": "diff --git a/tests/forms_tests/tests/test_error_messages.py b/tests/forms_tests/tests/test_error_messages.py\n--- a/tests/forms_tests/tests/test_error_messages.py\n+++ b/tests/forms_tests/tests/test_error_messages.py\n@@ -308,3 +308,16 @@ def test_modelchoicefield(self):\n         self.assertFormErrors(['REQUIRED'], f.clean, '')\n         self.assertFormErrors(['NOT A LIST OF VALUES'], f.clean, '3')\n         self.assertFormErrors(['4 IS INVALID CHOICE'], f.clean, ['4'])\n+\n+    def test_modelchoicefield_value_placeholder(self):\n+        f = ModelChoiceField(\n+            queryset=ChoiceModel.objects.all(),\n+            error_messages={\n+                'invalid_choice': '\"%(value)s\" is not one of the available choices.',\n+            },\n+        )\n+        self.assertFormErrors(\n+            ['\"invalid\" is not one of the available choices.'],\n+            f.clean,\n+            'invalid',\n+        )\n", "problem_statement": "ModelChoiceField does not provide value of invalid choice when raising ValidationError\nDescription\n\t \n\t\t(last modified by Aaron Wiegel)\n\t \nCompared with ChoiceField and others, ModelChoiceField does not show the value of the invalid choice when raising a validation error. Passing in parameters with the invalid value and modifying the default error message for the code invalid_choice should fix this.\nFrom source code:\nclass ModelMultipleChoiceField(ModelChoiceField):\n\t\"\"\"A MultipleChoiceField whose choices are a model QuerySet.\"\"\"\n\twidget = SelectMultiple\n\thidden_widget = MultipleHiddenInput\n\tdefault_error_messages = {\n\t\t'invalid_list': _('Enter a list of values.'),\n\t\t'invalid_choice': _('Select a valid choice. %(value)s is not one of the'\n\t\t\t\t\t\t\t' available choices.'),\n\t\t'invalid_pk_value': _('\u201c%(pk)s\u201d is not a valid value.')\n\t}\n\t...\nclass ModelChoiceField(ChoiceField):\n\t\"\"\"A ChoiceField whose choices are a model QuerySet.\"\"\"\n\t# This class is a subclass of ChoiceField for purity, but it doesn't\n\t# actually use any of ChoiceField's implementation.\n\tdefault_error_messages = {\n\t\t'invalid_choice': _('Select a valid choice. That choice is not one of'\n\t\t\t\t\t\t\t' the available choices.'),\n\t}\n\t...\n", "hints_text": "This message has been the same literally forever b2b6fc8e3c78671c8b6af2709358c3213c84d119. \u200bGiven that ChoiceField passes the value when raising the error, if you set \u200berror_messages you should be able to get the result you want.\nReplying to Carlton Gibson: This message has been the same literally forever b2b6fc8e3c78671c8b6af2709358c3213c84d119. \u200bGiven that ChoiceField passes the value when raising the error, if you set \u200berror_messages you should be able to get the result you want. That is ChoiceField. ModelChoiceField \u200bdoes not pass the value to the validation error. So, when the invalid value error is raised, you can't display the offending value even if you override the defaults.\nOK, if you want to look at submitting a PR we can see if any objections come up in review. Thanks.\nPR: \u200bhttps://github.com/django/django/pull/13933", "created_at": "2021-01-26T03:58:23Z", "version": "4.0", "FAIL_TO_PASS": "[\"test_modelchoicefield_value_placeholder (forms_tests.tests.test_error_messages.ModelChoiceFieldErrorMessagesTestCase)\"]", "PASS_TO_PASS": "[\"test_modelchoicefield (forms_tests.tests.test_error_messages.ModelChoiceFieldErrorMessagesTestCase)\", \"test_booleanfield (forms_tests.tests.test_error_messages.FormsErrorMessagesTestCase)\", \"test_charfield (forms_tests.tests.test_error_messages.FormsErrorMessagesTestCase)\", \"test_choicefield (forms_tests.tests.test_error_messages.FormsErrorMessagesTestCase)\", \"test_datefield (forms_tests.tests.test_error_messages.FormsErrorMessagesTestCase)\", \"test_datetimefield (forms_tests.tests.test_error_messages.FormsErrorMessagesTestCase)\", \"test_decimalfield (forms_tests.tests.test_error_messages.FormsErrorMessagesTestCase)\", \"test_emailfield (forms_tests.tests.test_error_messages.FormsErrorMessagesTestCase)\", \"test_error_messages_escaping (forms_tests.tests.test_error_messages.FormsErrorMessagesTestCase)\", \"test_filefield (forms_tests.tests.test_error_messages.FormsErrorMessagesTestCase)\", \"test_floatfield (forms_tests.tests.test_error_messages.FormsErrorMessagesTestCase)\", \"test_generic_ipaddressfield (forms_tests.tests.test_error_messages.FormsErrorMessagesTestCase)\", \"test_integerfield (forms_tests.tests.test_error_messages.FormsErrorMessagesTestCase)\", \"test_multiplechoicefield (forms_tests.tests.test_error_messages.FormsErrorMessagesTestCase)\", \"test_regexfield (forms_tests.tests.test_error_messages.FormsErrorMessagesTestCase)\", \"test_splitdatetimefield (forms_tests.tests.test_error_messages.FormsErrorMessagesTestCase)\", \"test_subclassing_errorlist (forms_tests.tests.test_error_messages.FormsErrorMessagesTestCase)\", \"test_timefield (forms_tests.tests.test_error_messages.FormsErrorMessagesTestCase)\", \"test_urlfield (forms_tests.tests.test_error_messages.FormsErrorMessagesTestCase)\"]", "environment_setup_commit": "475cffd1d64c690cdad16ede4d5e81985738ceb4"}, "On branch main\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   django/forms/models.py\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")\ncommit 42e8cf47c7ee2db238bf91197ea398126c546741\nAuthor: Simon Charette <charette.s@gmail.com>\nDate:   Mon Jan 25 23:32:55 2021 -0500\n\n    Fixed #32369 -- Fixed adding check constraints with pattern lookups and expressions as rhs.\n    \n    This disables interpolation of constraint creation statements. Since\n    Constraint.create_sql interpolates its parameters instead of deferring\n    this responsibility to the backend connection it must disable\n    connection level parameters interpolation.\n\ndiff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex be33ab3e4d..f879d59fa9 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -360,6 +360,8 @@ class BaseDatabaseSchemaEditor:\n             not self.connection.features.supports_expression_indexes\n         ):\n             return None\n+        # Index.create_sql returns interpolated SQL which makes params=None a\n+        # necessity to avoid escaping attempts on execution.\n         self.execute(index.create_sql(model, self), params=None)\n \n     def remove_index(self, model, index):\n@@ -375,7 +377,9 @@ class BaseDatabaseSchemaEditor:\n         \"\"\"Add a constraint to a model.\"\"\"\n         sql = constraint.create_sql(model, self)\n         if sql:\n-            self.execute(sql)\n+            # Constraint.create_sql returns interpolated SQL which makes\n+            # params=None a necessity to avoid escaping attempts on execution.\n+            self.execute(sql, params=None)\n \n     def remove_constraint(self, model, constraint):\n         \"\"\"Remove a constraint from a model.\"\"\"\ndiff --git a/tests/migrations/test_operations.py b/tests/migrations/test_operations.py\nindex 897808f75b..984aefa23d 100644\n--- a/tests/migrations/test_operations.py\n+++ b/tests/migrations/test_operations.py\n@@ -2145,6 +2145,7 @@ class OperationTests(OperationTestBase):\n                 fields=[\n                     ('id', models.AutoField(primary_key=True)),\n                     ('name', models.CharField(max_length=100)),\n+                    ('surname', models.CharField(max_length=100, default='')),\n                     ('rebate', models.CharField(max_length=100)),\n                 ],\n             ),\n@@ -2178,6 +2179,19 @@ class OperationTests(OperationTestBase):\n             Author.objects.create(name='Albert', rebate='10$')\n         author = Author.objects.create(name='Albert', rebate='10%')\n         self.assertEqual(Author.objects.get(), author)\n+        # Right-hand-side baked \"%\" literals should not be used for parameters\n+        # interpolation.\n+        check = ~models.Q(surname__startswith=models.F('name'))\n+        constraint = models.CheckConstraint(check=check, name='name_constraint_rhs')\n+        operation = migrations.AddConstraint('Author', constraint)\n+        from_state = to_state\n+        to_state = from_state.clone()\n+        operation.state_forwards(app_label, to_state)\n+        with connection.schema_editor() as editor:\n+            operation.database_forwards(app_label, editor, from_state, to_state)\n+        Author = to_state.apps.get_model(app_label, 'Author')\n+        with self.assertRaises(IntegrityError), transaction.atomic():\n+            Author.objects.create(name='Albert', surname='Alberto')\n \n     @skipUnlessDBFeature('supports_table_check_constraints')\n     def test_add_or_constraint(self):\ndiff --git a/django/forms/models.py b/django/forms/models.py\nindex 422bc5d178..a88c384841 100644\n--- a/django/forms/models.py\n+++ b/django/forms/models.py\n@@ -1284,7 +1284,11 @@ class ModelChoiceField(ChoiceField):\n                 value = getattr(value, key)\n             value = self.queryset.get(**{key: value})\n         except (ValueError, TypeError, self.queryset.model.DoesNotExist):\n-            raise ValidationError(self.error_messages['invalid_choice'], code='invalid_choice')\n+            raise ValidationError(\n+                self.error_messages['invalid_choice'],\n+                code='invalid_choice',\n+                params={'value': value},\n+            )\n         return value\n \n     def validate(self, value):\nObtaining file:///testbed\n  Preparing metadata (setup.py): started\n  Preparing metadata (setup.py): finished with status 'done'\nRequirement already satisfied: asgiref>=3.2.10 in /opt/miniconda3/envs/testbed/lib/python3.8/site-packages (from Django==4.0) (3.8.1)\nRequirement already satisfied: pytz in /opt/miniconda3/envs/testbed/lib/python3.8/site-packages (from Django==4.0) (2024.2)\nRequirement already satisfied: sqlparse>=0.2.2 in /opt/miniconda3/envs/testbed/lib/python3.8/site-packages (from Django==4.0) (0.5.1)\nRequirement already satisfied: typing-extensions>=4 in /opt/miniconda3/envs/testbed/lib/python3.8/site-packages (from asgiref>=3.2.10->Django==4.0) (4.12.2)\nInstalling collected packages: Django\n  Attempting uninstall: Django\n    Found existing installation: Django 4.0\n    Uninstalling Django-4.0:\n      Successfully uninstalled Django-4.0\n  Running setup.py develop for Django\nSuccessfully installed Django\nTesting against Django installed in '/testbed/django'\nImporting application forms_tests\nSkipping setup of unused database(s): other.\nOperations to perform:\n  Synchronize unmigrated apps: auth, contenttypes, forms_tests, messages, sessions, staticfiles\n  Apply all migrations: admin, sites\nSynchronizing apps without migrations:\n  Creating tables...\n    Creating table django_content_type\n    Creating table auth_permission\n    Creating table auth_group\n    Creating table auth_user\n    Creating table django_session\n    Creating table forms_tests_boundarymodel\n    Creating table forms_tests_defaults\n    Creating table forms_tests_choicemodel\n    Creating table forms_tests_choiceoptionmodel\n    Creating table forms_tests_choicefieldmodel\n    Creating table forms_tests_optionalmultichoicemodel\n    Creating table forms_tests_filemodel\n    Creating table forms_tests_article\n    Running deferred SQL...\nRunning migrations:\n  Applying admin.0001_initial... OK\n  Applying admin.0002_logentry_remove_auto_add... OK\n  Applying admin.0003_logentry_add_action_flag_choices... OK\n  Applying sites.0001_initial... OK\n  Applying sites.0002_alter_domain_unique... OK\nSystem check identified no issues (0 silenced).\n", {}]