[{"repo": "sympy/sympy", "instance_id": "sympy__sympy-21627", "base_commit": "126f80578140e752ad5135aac77b8ff887eede3e", "patch": "diff --git a/sympy/functions/elementary/complexes.py b/sympy/functions/elementary/complexes.py\n--- a/sympy/functions/elementary/complexes.py\n+++ b/sympy/functions/elementary/complexes.py\n@@ -607,6 +607,8 @@ def eval(cls, arg):\n             arg2 = -S.ImaginaryUnit * arg\n             if arg2.is_extended_nonnegative:\n                 return arg2\n+        if arg.is_extended_real:\n+            return\n         # reject result if all new conjugates are just wrappers around\n         # an expression that was already in the arg\n         conj = signsimp(arg.conjugate(), evaluate=False)\n", "test_patch": "diff --git a/sympy/functions/elementary/tests/test_complexes.py b/sympy/functions/elementary/tests/test_complexes.py\n--- a/sympy/functions/elementary/tests/test_complexes.py\n+++ b/sympy/functions/elementary/tests/test_complexes.py\n@@ -464,6 +464,8 @@ def test_Abs():\n     # issue 19627\n     f = Function('f', positive=True)\n     assert sqrt(f(x)**2) == f(x)\n+    # issue 21625\n+    assert unchanged(Abs, S(\"im(acos(-i + acosh(-g + i)))\"))\n \n \n def test_Abs_rewrite():\n", "problem_statement": "Bug: maximum recusion depth error when checking is_zero of cosh expression\nThe following code causes a `RecursionError: maximum recursion depth exceeded while calling a Python object` error when checked if it is zero:\r\n```\r\nexpr =sympify(\"cosh(acos(-i + acosh(-g + i)))\")\r\nexpr.is_zero\r\n```\n", "hints_text": "The problem is with `Abs`:\r\n```python\r\nIn [7]: e = S(\"im(acos(-i + acosh(-g + i)))\")                                                        \r\n\r\nIn [8]: abs(e)\r\n```\r\nThat leads to this:\r\nhttps://github.com/sympy/sympy/blob/126f80578140e752ad5135aac77b8ff887eede3e/sympy/functions/elementary/complexes.py#L616-L621\r\nand then `sqrt` leads here:\r\nhttps://github.com/sympy/sympy/blob/126f80578140e752ad5135aac77b8ff887eede3e/sympy/core/power.py#L336\r\nwhich goes to here:\r\nhttps://github.com/sympy/sympy/blob/126f80578140e752ad5135aac77b8ff887eede3e/sympy/core/power.py#L418\r\nAnd then that's trying to compute the same abs again.\r\n\r\nI'm not sure where the cycle should be broken but the code in `Abs.eval` seems excessively complicated.\r\n\n> That leads to this:\r\n\r\nThe test should be changed to:\r\n```python\r\n_arg = signsimp(arg, evaluate=False)\r\nif _arg != conj or _arg != -conj:\r\n```\n We should probably never come to this test when the argument is real. There should be something like `if arg.is_extended_real` before `conj` is computed.\nThere are tests for nonnegative, nonpositive and imaginary. So an additional test before coming to this part would be\r\n```python\r\nif arg.is_extended_real:\r\n    return\r\n...\r\n_arg = signsimp(arg, evaluate=False)\r\nif _arg not in (conj, -conj):\r\n...\r\n```", "created_at": "2021-06-16T17:29:41Z", "version": "1.9", "FAIL_TO_PASS": "[\"test_Abs\"]", "PASS_TO_PASS": "[\"test_re\", \"test_im\", \"test_sign\", \"test_as_real_imag\", \"test_Abs_rewrite\", \"test_Abs_real\", \"test_Abs_properties\", \"test_abs\", \"test_arg\", \"test_arg_rewrite\", \"test_adjoint\", \"test_conjugate\", \"test_conjugate_transpose\", \"test_transpose\", \"test_polarify\", \"test_unpolarify\", \"test_issue_4035\", \"test_issue_3206\", \"test_issue_4754_derivative_conjugate\", \"test_derivatives_issue_4757\", \"test_issue_11413\", \"test_periodic_argument\", \"test_principal_branch\", \"test_issue_14216\", \"test_issue_14238\", \"test_zero_assumptions\"]", "environment_setup_commit": "f9a6f50ec0c74d935c50a6e9c9b2cb0469570d91"}, "On branch master\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   sympy/functions/elementary/complexes.py\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")\ncommit 126f80578140e752ad5135aac77b8ff887eede3e\nMerge: 1fb2490fa2 7738b7fdc6\nAuthor: Chris Smith <smichr@gmail.com>\nDate:   Wed Jun 16 06:27:22 2021 -0500\n\n    Merge pull request #21608 from bjodah/rewrite-expm1-add-test-for-gh21531\n    \n    codegen: more capable rewrite to expm1 & cosm1 etc.\n\ndiff --git a/sympy/functions/elementary/complexes.py b/sympy/functions/elementary/complexes.py\nindex 66a96335eb..c6871b79dd 100644\n--- a/sympy/functions/elementary/complexes.py\n+++ b/sympy/functions/elementary/complexes.py\n@@ -607,6 +607,8 @@ def eval(cls, arg):\n             arg2 = -S.ImaginaryUnit * arg\n             if arg2.is_extended_nonnegative:\n                 return arg2\n+        if arg.is_extended_real:\n+            return\n         # reject result if all new conjugates are just wrappers around\n         # an expression that was already in the arg\n         conj = signsimp(arg.conjugate(), evaluate=False)\nObtaining file:///testbed\n  Preparing metadata (setup.py): started\n  Preparing metadata (setup.py): finished with status 'done'\nRequirement already satisfied: mpmath>=0.19 in /opt/miniconda3/envs/testbed/lib/python3.9/site-packages (from sympy==1.9.dev0) (1.3.0)\nInstalling collected packages: sympy\n  Attempting uninstall: sympy\n    Found existing installation: sympy 1.9.dev0\n    Uninstalling sympy-1.9.dev0:\n      Successfully uninstalled sympy-1.9.dev0\n  Running setup.py develop for sympy\nSuccessfully installed sympy\n============================= test process starts ==============================\nexecutable:         /opt/miniconda3/envs/testbed/bin/python  (3.9.20-final-0) [CPython]\narchitecture:       64-bit\ncache:              no\nground types:       python \nnumpy:              None\nrandom seed:        86854727\nhash randomization: off\n\nsympy/functions/elementary/tests/test_complexes.py[31] \ntest_re ok\ntest_im ok\ntest_sign ok\ntest_as_real_imag ok\ntest_sign_issue_3068 f\ntest_Abs ok\ntest_Abs_rewrite ok\ntest_Abs_real ok\ntest_Abs_properties ok\ntest_abs ok\ntest_arg ok\ntest_arg_rewrite ok\ntest_adjoint ok\ntest_conjugate ok\ntest_conjugate_transpose ok\ntest_transpose ok\ntest_polarify ok\ntest_unpolarify ok\ntest_issue_4035 ok\ntest_issue_3206 ok\ntest_issue_4754_derivative_conjugate ok\ntest_derivatives_issue_4757 ok\ntest_issue_11413 ok\ntest_periodic_argument ok\ntest_principal_branch_fail f\ntest_principal_branch ok\ntest_issue_6167_6151 f\ntest_issue_14216 ok\ntest_issue_14238 ok\ntest_zero_assumptions ok\ntest_issue_15893 ok                                                         [OK]\n\n\n======== tests finished: 28 passed, 3 expected to fail, in 9.50 seconds ========\n", {"test_re": "PASSED", "test_im": "PASSED", "test_sign": "PASSED", "test_as_real_imag": "PASSED", "test_Abs": "PASSED", "test_Abs_rewrite": "PASSED", "test_Abs_real": "PASSED", "test_Abs_properties": "PASSED", "test_abs": "PASSED", "test_arg": "PASSED", "test_arg_rewrite": "PASSED", "test_adjoint": "PASSED", "test_conjugate": "PASSED", "test_conjugate_transpose": "PASSED", "test_transpose": "PASSED", "test_polarify": "PASSED", "test_unpolarify": "PASSED", "test_issue_4035": "PASSED", "test_issue_3206": "PASSED", "test_issue_4754_derivative_conjugate": "PASSED", "test_derivatives_issue_4757": "PASSED", "test_issue_11413": "PASSED", "test_periodic_argument": "PASSED", "test_principal_branch": "PASSED", "test_issue_14216": "PASSED", "test_issue_14238": "PASSED", "test_zero_assumptions": "PASSED"}]