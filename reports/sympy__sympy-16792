[{"repo": "sympy/sympy", "instance_id": "sympy__sympy-16792", "base_commit": "09786a173e7a0a488f46dd6000177c23e5d24eed", "patch": "diff --git a/sympy/utilities/codegen.py b/sympy/utilities/codegen.py\n--- a/sympy/utilities/codegen.py\n+++ b/sympy/utilities/codegen.py\n@@ -695,6 +695,11 @@ def routine(self, name, expr, argument_sequence=None, global_vars=None):\n         arg_list = []\n \n         # setup input argument list\n+\n+        # helper to get dimensions for data for array-like args\n+        def dimensions(s):\n+            return [(S.Zero, dim - 1) for dim in s.shape]\n+\n         array_symbols = {}\n         for array in expressions.atoms(Indexed) | local_expressions.atoms(Indexed):\n             array_symbols[array.base.label] = array\n@@ -703,11 +708,8 @@ def routine(self, name, expr, argument_sequence=None, global_vars=None):\n \n         for symbol in sorted(symbols, key=str):\n             if symbol in array_symbols:\n-                dims = []\n                 array = array_symbols[symbol]\n-                for dim in array.shape:\n-                    dims.append((S.Zero, dim - 1))\n-                metadata = {'dimensions': dims}\n+                metadata = {'dimensions': dimensions(array)}\n             else:\n                 metadata = {}\n \n@@ -739,7 +741,11 @@ def routine(self, name, expr, argument_sequence=None, global_vars=None):\n                 try:\n                     new_args.append(name_arg_dict[symbol])\n                 except KeyError:\n-                    new_args.append(InputArgument(symbol))\n+                    if isinstance(symbol, (IndexedBase, MatrixSymbol)):\n+                        metadata = {'dimensions': dimensions(symbol)}\n+                    else:\n+                        metadata = {}\n+                    new_args.append(InputArgument(symbol, **metadata))\n             arg_list = new_args\n \n         return Routine(name, arg_list, return_val, local_vars, global_vars)\n", "test_patch": "diff --git a/sympy/utilities/tests/test_codegen.py b/sympy/utilities/tests/test_codegen.py\n--- a/sympy/utilities/tests/test_codegen.py\n+++ b/sympy/utilities/tests/test_codegen.py\n@@ -582,6 +582,25 @@ def test_ccode_cse():\n     )\n     assert source == expected\n \n+def test_ccode_unused_array_arg():\n+    x = MatrixSymbol('x', 2, 1)\n+    # x does not appear in output\n+    name_expr = (\"test\", 1.0)\n+    generator = CCodeGen()\n+    result = codegen(name_expr, code_gen=generator, header=False, empty=False, argument_sequence=(x,))\n+    source = result[0][1]\n+    # note: x should appear as (double *)\n+    expected = (\n+        '#include \"test.h\"\\n'\n+        '#include <math.h>\\n'\n+        'double test(double *x) {\\n'\n+        '   double test_result;\\n'\n+        '   test_result = 1.0;\\n'\n+        '   return test_result;\\n'\n+        '}\\n'\n+    )\n+    assert source == expected\n+\n def test_empty_f_code():\n     code_gen = FCodeGen()\n     source = get_string(code_gen.dump_f95, [])\n", "problem_statement": "autowrap with cython backend fails when array arguments do not appear in wrapped expr\nWhen using the cython backend for autowrap, it appears that the code is not correctly generated when the function in question has array arguments that do not appear in the final expression. A minimal counterexample is:\r\n\r\n```python\r\nfrom sympy.utilities.autowrap import autowrap\r\nfrom sympy import MatrixSymbol\r\nimport numpy as np\r\n\r\nx = MatrixSymbol('x', 2, 1)\r\nexpr = 1.0\r\nf = autowrap(expr, args=(x,), backend='cython')\r\n\r\nf(np.array([[1.0, 2.0]]))\r\n```\r\n\r\nThis should of course return `1.0` but instead fails with:\r\n```python\r\nTypeError: only size-1 arrays can be converted to Python scalars\r\n```\r\n\r\nA little inspection reveals that this is because the corresponding C function is generated with an incorrect signature:\r\n\r\n```C\r\ndouble autofunc(double x) {\r\n\r\n   double autofunc_result;\r\n   autofunc_result = 1.0;\r\n   return autofunc_result;\r\n\r\n}\r\n```\r\n\r\n(`x` should be `double *`, not `double` in this case)\r\n\r\nI've found that this error won't occur so long as `expr` depends at least in part on each argument. For example this slight modification of the above counterexample works perfectly:\r\n\r\n```python\r\nfrom sympy.utilities.autowrap import autowrap\r\nfrom sympy import MatrixSymbol\r\nimport numpy as np\r\n\r\nx = MatrixSymbol('x', 2, 1)\r\n# now output depends on x\r\nexpr = x[0,0]\r\nf = autowrap(expr, args=(x,), backend='cython')\r\n\r\n# returns 1.0 as expected, without failure\r\nf(np.array([[1.0, 2.0]]))\r\n```\r\n\r\nThis may seem like a silly issue (\"why even have `x` as an argument if it doesn't appear in the expression you're trying to evaluate?\"). But of course in interfacing with external libraries (e.g. for numerical integration), one often needs functions to have a pre-defined signature regardless of whether a given argument contributes to the output.\r\n\r\nI think I've identified the problem in `codegen` and will suggest a PR shortly.\n", "hints_text": "", "created_at": "2019-05-09T03:40:54Z", "version": "1.5", "FAIL_TO_PASS": "[\"test_ccode_unused_array_arg\"]", "PASS_TO_PASS": "[\"test_Routine_argument_order\", \"test_empty_c_code\", \"test_empty_c_code_with_comment\", \"test_empty_c_header\", \"test_simple_c_code\", \"test_c_code_reserved_words\", \"test_numbersymbol_c_code\", \"test_c_code_argument_order\", \"test_simple_c_header\", \"test_simple_c_codegen\", \"test_multiple_results_c\", \"test_no_results_c\", \"test_ansi_math1_codegen\", \"test_ansi_math2_codegen\", \"test_complicated_codegen\", \"test_loops_c\", \"test_dummy_loops_c\", \"test_partial_loops_c\", \"test_output_arg_c\", \"test_output_arg_c_reserved_words\", \"test_ccode_results_named_ordered\", \"test_ccode_matrixsymbol_slice\", \"test_ccode_cse\", \"test_empty_f_code\", \"test_empty_f_code_with_header\", \"test_empty_f_header\", \"test_simple_f_code\", \"test_numbersymbol_f_code\", \"test_erf_f_code\", \"test_f_code_argument_order\", \"test_simple_f_header\", \"test_simple_f_codegen\", \"test_multiple_results_f\", \"test_no_results_f\", \"test_intrinsic_math_codegen\", \"test_intrinsic_math2_codegen\", \"test_complicated_codegen_f95\", \"test_loops\", \"test_dummy_loops_f95\", \"test_loops_InOut\", \"test_partial_loops_f\", \"test_output_arg_f\", \"test_inline_function\", \"test_f_code_call_signature_wrap\", \"test_check_case\", \"test_check_case_false_positive\", \"test_c_fortran_omit_routine_name\", \"test_fcode_matrix_output\", \"test_fcode_results_named_ordered\", \"test_fcode_matrixsymbol_slice\", \"test_fcode_matrixsymbol_slice_autoname\", \"test_global_vars\", \"test_custom_codegen\", \"test_c_with_printer\"]", "environment_setup_commit": "70381f282f2d9d039da860e391fe51649df2779d"}, "On branch master\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   sympy/utilities/codegen.py\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")\ncommit 09786a173e7a0a488f46dd6000177c23e5d24eed\nMerge: 7ec680459c 1175c13f7e\nAuthor: Aaron Meurer <asmeurer@gmail.com>\nDate:   Wed May 8 19:39:54 2019 -0600\n\n    Merge pull request #16652 from parkereberry1923/Issue-12134-Python-Numbers-ABC\n    \n    SymPy numbers now inherit from Python numbers ABCs\n\ndiff --cc sympy/core/tests/test_numbers.py\nindex b6685db140,a88226f07b..a5d2f95db7\n--- a/sympy/core/tests/test_numbers.py\n+++ b/sympy/core/tests/test_numbers.py\n@@@ -19,14 -21,9 +21,12 @@@ from sympy.utilities.pytest import XFAI\n  from mpmath import mpf\n  from mpmath.rational import mpq\n  import mpmath\n- \n- \n- \n+ from sympy import numbers\n  t = Symbol('t', real=False)\n  \n +_ninf = float(-oo)\n +_inf = float(oo)\n +\n  def same_and_same_prec(a, b):\n      # stricter matching for Floats\n      return a == b and a._prec == b._prec\ndiff --git a/sympy/utilities/codegen.py b/sympy/utilities/codegen.py\nindex f0befb2bd7..194aafc376 100644\n--- a/sympy/utilities/codegen.py\n+++ b/sympy/utilities/codegen.py\n@@ -695,6 +695,11 @@ def routine(self, name, expr, argument_sequence=None, global_vars=None):\n         arg_list = []\n \n         # setup input argument list\n+\n+        # helper to get dimensions for data for array-like args\n+        def dimensions(s):\n+            return [(S.Zero, dim - 1) for dim in s.shape]\n+\n         array_symbols = {}\n         for array in expressions.atoms(Indexed) | local_expressions.atoms(Indexed):\n             array_symbols[array.base.label] = array\n@@ -703,11 +708,8 @@ def routine(self, name, expr, argument_sequence=None, global_vars=None):\n \n         for symbol in sorted(symbols, key=str):\n             if symbol in array_symbols:\n-                dims = []\n                 array = array_symbols[symbol]\n-                for dim in array.shape:\n-                    dims.append((S.Zero, dim - 1))\n-                metadata = {'dimensions': dims}\n+                metadata = {'dimensions': dimensions(array)}\n             else:\n                 metadata = {}\n \n@@ -739,7 +741,11 @@ def routine(self, name, expr, argument_sequence=None, global_vars=None):\n                 try:\n                     new_args.append(name_arg_dict[symbol])\n                 except KeyError:\n-                    new_args.append(InputArgument(symbol))\n+                    if isinstance(symbol, (IndexedBase, MatrixSymbol)):\n+                        metadata = {'dimensions': dimensions(symbol)}\n+                    else:\n+                        metadata = {}\n+                    new_args.append(InputArgument(symbol, **metadata))\n             arg_list = new_args\n \n         return Routine(name, arg_list, return_val, local_vars, global_vars)\nObtaining file:///testbed\n  Preparing metadata (setup.py): started\n  Preparing metadata (setup.py): finished with status 'done'\nRequirement already satisfied: mpmath>=0.19 in /opt/miniconda3/envs/testbed/lib/python3.9/site-packages (from sympy==1.5.dev0) (1.3.0)\nInstalling collected packages: sympy\n  Attempting uninstall: sympy\n    Found existing installation: sympy 1.5.dev0\n    Uninstalling sympy-1.5.dev0:\n      Successfully uninstalled sympy-1.5.dev0\n  Running setup.py develop for sympy\nSuccessfully installed sympy\n============================= test process starts ==============================\nexecutable:         /opt/miniconda3/envs/testbed/bin/python  (3.9.20-final-0) [CPython]\narchitecture:       64-bit\ncache:              no\nground types:       python \nnumpy:              None\nrandom seed:        86069280\nhash randomization: off\n\nsympy/utilities/tests/test_codegen.py[56] \ntest_Routine_argument_order ok\ntest_empty_c_code ok\ntest_empty_c_code_with_comment ok\ntest_empty_c_header ok\ntest_simple_c_code ok\ntest_c_code_reserved_words ok\ntest_numbersymbol_c_code ok\ntest_c_code_argument_order ok\ntest_simple_c_header ok\ntest_simple_c_codegen ok\ntest_multiple_results_c ok\ntest_no_results_c ok\ntest_ansi_math1_codegen ok\ntest_ansi_math2_codegen ok\ntest_complicated_codegen ok\ntest_loops_c ok\ntest_dummy_loops_c ok\ntest_partial_loops_c ok\ntest_output_arg_c ok\ntest_output_arg_c_reserved_words ok\ntest_ccode_results_named_ordered ok\ntest_ccode_matrixsymbol_slice ok\ntest_ccode_cse ok\ntest_ccode_unused_array_arg ok\ntest_empty_f_code ok\ntest_empty_f_code_with_header ok\ntest_empty_f_header ok\ntest_simple_f_code ok\ntest_numbersymbol_f_code ok\ntest_erf_f_code ok\ntest_f_code_argument_order ok\ntest_simple_f_header ok\ntest_simple_f_codegen ok\ntest_multiple_results_f ok\ntest_no_results_f ok\ntest_intrinsic_math_codegen ok\ntest_intrinsic_math2_codegen ok\ntest_complicated_codegen_f95 ok\ntest_loops ok\ntest_dummy_loops_f95 ok\ntest_loops_InOut ok\ntest_partial_loops_f ok\ntest_output_arg_f ok\ntest_inline_function ok\ntest_f_code_call_signature_wrap ok\ntest_check_case ok\ntest_check_case_false_positive ok\ntest_c_fortran_omit_routine_name ok\ntest_fcode_matrix_output ok\ntest_fcode_results_named_ordered ok\ntest_fcode_matrixsymbol_slice ok\ntest_fcode_matrixsymbol_slice_autoname ok\ntest_global_vars ok\ntest_custom_codegen ok\ntest_c_with_printer ok\ntest_fcode_complex ok                                                       [OK]\n\n\n================== tests finished: 56 passed, in 1.35 seconds ==================\n", {"test_Routine_argument_order": "PASSED", "test_empty_c_code": "PASSED", "test_empty_c_code_with_comment": "PASSED", "test_empty_c_header": "PASSED", "test_simple_c_code": "PASSED", "test_c_code_reserved_words": "PASSED", "test_numbersymbol_c_code": "PASSED", "test_c_code_argument_order": "PASSED", "test_simple_c_header": "PASSED", "test_simple_c_codegen": "PASSED", "test_multiple_results_c": "PASSED", "test_no_results_c": "PASSED", "test_ansi_math1_codegen": "PASSED", "test_ansi_math2_codegen": "PASSED", "test_complicated_codegen": "PASSED", "test_loops_c": "PASSED", "test_dummy_loops_c": "PASSED", "test_partial_loops_c": "PASSED", "test_output_arg_c": "PASSED", "test_output_arg_c_reserved_words": "PASSED", "test_ccode_results_named_ordered": "PASSED", "test_ccode_matrixsymbol_slice": "PASSED", "test_ccode_cse": "PASSED", "test_ccode_unused_array_arg": "PASSED", "test_empty_f_code": "PASSED", "test_empty_f_code_with_header": "PASSED", "test_empty_f_header": "PASSED", "test_simple_f_code": "PASSED", "test_numbersymbol_f_code": "PASSED", "test_erf_f_code": "PASSED", "test_f_code_argument_order": "PASSED", "test_simple_f_header": "PASSED", "test_simple_f_codegen": "PASSED", "test_multiple_results_f": "PASSED", "test_no_results_f": "PASSED", "test_intrinsic_math_codegen": "PASSED", "test_intrinsic_math2_codegen": "PASSED", "test_complicated_codegen_f95": "PASSED", "test_loops": "PASSED", "test_dummy_loops_f95": "PASSED", "test_loops_InOut": "PASSED", "test_partial_loops_f": "PASSED", "test_output_arg_f": "PASSED", "test_inline_function": "PASSED", "test_f_code_call_signature_wrap": "PASSED", "test_check_case": "PASSED", "test_check_case_false_positive": "PASSED", "test_c_fortran_omit_routine_name": "PASSED", "test_fcode_matrix_output": "PASSED", "test_fcode_results_named_ordered": "PASSED", "test_fcode_matrixsymbol_slice": "PASSED", "test_fcode_matrixsymbol_slice_autoname": "PASSED", "test_global_vars": "PASSED", "test_custom_codegen": "PASSED", "test_c_with_printer": "PASSED"}]