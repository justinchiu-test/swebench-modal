[{"repo": "django/django", "instance_id": "django__django-12308", "base_commit": "2e0f04507b17362239ba49830d26fec504d46978", "patch": "diff --git a/django/contrib/admin/utils.py b/django/contrib/admin/utils.py\n--- a/django/contrib/admin/utils.py\n+++ b/django/contrib/admin/utils.py\n@@ -398,6 +398,11 @@ def display_for_field(value, field, empty_value_display):\n         return formats.number_format(value)\n     elif isinstance(field, models.FileField) and value:\n         return format_html('<a href=\"{}\">{}</a>', value.url, value)\n+    elif isinstance(field, models.JSONField) and value:\n+        try:\n+            return field.get_prep_value(value)\n+        except TypeError:\n+            return display_for_value(value, empty_value_display)\n     else:\n         return display_for_value(value, empty_value_display)\n \n", "test_patch": "diff --git a/tests/admin_utils/tests.py b/tests/admin_utils/tests.py\n--- a/tests/admin_utils/tests.py\n+++ b/tests/admin_utils/tests.py\n@@ -176,6 +176,23 @@ def test_null_display_for_field(self):\n         display_value = display_for_field(None, models.FloatField(), self.empty_value)\n         self.assertEqual(display_value, self.empty_value)\n \n+        display_value = display_for_field(None, models.JSONField(), self.empty_value)\n+        self.assertEqual(display_value, self.empty_value)\n+\n+    def test_json_display_for_field(self):\n+        tests = [\n+            ({'a': {'b': 'c'}}, '{\"a\": {\"b\": \"c\"}}'),\n+            (['a', 'b'], '[\"a\", \"b\"]'),\n+            ('a', '\"a\"'),\n+            ({('a', 'b'): 'c'}, \"{('a', 'b'): 'c'}\"),  # Invalid JSON.\n+        ]\n+        for value, display_value in tests:\n+            with self.subTest(value=value):\n+                self.assertEqual(\n+                    display_for_field(value, models.JSONField(), self.empty_value),\n+                    display_value,\n+                )\n+\n     def test_number_formats_display_for_field(self):\n         display_value = display_for_field(12345.6789, models.FloatField(), self.empty_value)\n         self.assertEqual(display_value, '12345.6789')\n", "problem_statement": "JSONField are not properly displayed in admin when they are readonly.\nDescription\n\t\nJSONField values are displayed as dict when readonly in the admin.\nFor example, {\"foo\": \"bar\"} would be displayed as {'foo': 'bar'}, which is not valid JSON.\nI believe the fix would be to add a special case in django.contrib.admin.utils.display_for_field to call the prepare_value of the JSONField (not calling json.dumps directly to take care of the InvalidJSONInput case).\n", "hints_text": "\u200bPR\nThe proposed patch is problematic as the first version coupled contrib.postgres with .admin and the current one is based off the type name which is brittle and doesn't account for inheritance. It might be worth waiting for #12990 to land before proceeding here as the patch will be able to simply rely of django.db.models.JSONField instance checks from that point.", "created_at": "2020-01-12T04:21:15Z", "version": "3.1", "FAIL_TO_PASS": "[\"test_json_display_for_field (admin_utils.tests.UtilsTests)\", \"test_label_for_field (admin_utils.tests.UtilsTests)\"]", "PASS_TO_PASS": "[\"test_cyclic (admin_utils.tests.NestedObjectsTests)\", \"test_non_added_parent (admin_utils.tests.NestedObjectsTests)\", \"test_on_delete_do_nothing (admin_utils.tests.NestedObjectsTests)\", \"test_queries (admin_utils.tests.NestedObjectsTests)\", \"test_relation_on_abstract (admin_utils.tests.NestedObjectsTests)\", \"test_siblings (admin_utils.tests.NestedObjectsTests)\", \"test_unrelated_roots (admin_utils.tests.NestedObjectsTests)\", \"test_flatten (admin_utils.tests.UtilsTests)\", \"test_flatten_fieldsets (admin_utils.tests.UtilsTests)\", \"test_label_for_field_form_argument (admin_utils.tests.UtilsTests)\", \"test_label_for_property (admin_utils.tests.UtilsTests)\", \"test_list_display_for_value (admin_utils.tests.UtilsTests)\", \"test_list_display_for_value_boolean (admin_utils.tests.UtilsTests)\", \"test_null_display_for_field (admin_utils.tests.UtilsTests)\", \"test_number_formats_display_for_field (admin_utils.tests.UtilsTests)\", \"test_number_formats_with_thousand_separator_display_for_field (admin_utils.tests.UtilsTests)\", \"test_quote (admin_utils.tests.UtilsTests)\", \"test_related_name (admin_utils.tests.UtilsTests)\", \"test_safestring_in_field_label (admin_utils.tests.UtilsTests)\", \"test_values_from_lookup_field (admin_utils.tests.UtilsTests)\"]", "environment_setup_commit": "0668164b4ac93a5be79f5b87fae83c657124d9ab"}, "Generating locales (this might take a while)...\n  en_US.UTF-8... done\nGeneration complete.\nOn branch main\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   django/contrib/admin/utils.py\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")\ncommit 2e0f04507b17362239ba49830d26fec504d46978\nAuthor: Paolo Melchiorre <paolo@melchiorre.org>\nDate:   Thu May 7 15:57:37 2020 +0200\n\n    Added tests for loaddata with gzip/bzip2 compressed fixtures.\n    \n    Co-authored-by: Adam Johnson <me@adamj.eu>\n\ndiff --git a/AUTHORS b/AUTHORS\nindex 3b91851ae6..79676cb559 100644\n--- a/AUTHORS\n+++ b/AUTHORS\n@@ -695,6 +695,7 @@ answer newbie questions, and generally made Django that much better:\n     Owen Griffiths\n     Pablo Mart\u00edn <goinnn@gmail.com>\n     Panos Laganakos <panos.laganakos@gmail.com>\n+    Paolo Melchiorre <paolo@melchiorre.org>\n     Pascal Hartig <phartig@rdrei.net>\n     Pascal Varet\n     Patrik Sletmo <patrik.sletmo@gmail.com>\ndiff --git a/tests/fixtures/fixtures/fixture5.json.bz2 b/tests/fixtures/fixtures/fixture5.json.bz2\nnew file mode 100644\nindex 0000000000..046bfa5820\nBinary files /dev/null and b/tests/fixtures/fixtures/fixture5.json.bz2 differ\ndiff --git a/tests/fixtures/tests.py b/tests/fixtures/tests.py\nindex 1e723a7b66..cac3ccabc4 100644\n--- a/tests/fixtures/tests.py\n+++ b/tests/fixtures/tests.py\n@@ -21,6 +21,12 @@ from .models import (\n     PrimaryKeyUUIDModel, ProxySpy, Spy, Tag, Visa,\n )\n \n+try:\n+    import bz2  # NOQA\n+    HAS_BZ2 = True\n+except ImportError:\n+    HAS_BZ2 = False\n+\n \n class TestCaseFixtureLoadingTests(TestCase):\n     fixtures = ['fixture1.json', 'fixture2.json']\n@@ -540,6 +546,19 @@ class FixtureLoadingTests(DumpDataAssertMixin, TestCase):\n             '<Article: WoW subscribers now outnumber readers>',\n         ])\n \n+    def test_compressed_loading_gzip(self):\n+        management.call_command('loaddata', 'fixture5.json.gz', verbosity=0)\n+        self.assertQuerysetEqual(Article.objects.all(), [\n+            '<Article: WoW subscribers now outnumber readers>',\n+        ])\n+\n+    @unittest.skipUnless(HAS_BZ2, 'No bz2 library detected.')\n+    def test_compressed_loading_bz2(self):\n+        management.call_command('loaddata', 'fixture5.json.bz2', verbosity=0)\n+        self.assertQuerysetEqual(Article.objects.all(), [\n+            '<Article: WoW subscribers now outnumber readers>',\n+        ])\n+\n     def test_ambiguous_compressed_fixture(self):\n         # The name \"fixture5\" is ambiguous, so loading raises an error.\n         msg = \"Multiple fixtures named 'fixture5'\"\ndiff --git a/django/contrib/admin/utils.py b/django/contrib/admin/utils.py\nindex e4ddc8f017..021a086e65 100644\n--- a/django/contrib/admin/utils.py\n+++ b/django/contrib/admin/utils.py\n@@ -398,6 +398,11 @@ def display_for_field(value, field, empty_value_display):\n         return formats.number_format(value)\n     elif isinstance(field, models.FileField) and value:\n         return format_html('<a href=\"{}\">{}</a>', value.url, value)\n+    elif isinstance(field, models.JSONField) and value:\n+        try:\n+            return field.get_prep_value(value)\n+        except TypeError:\n+            return display_for_value(value, empty_value_display)\n     else:\n         return display_for_value(value, empty_value_display)\n \nObtaining file:///testbed\nRequirement already satisfied: asgiref>=3.2 in /opt/miniconda3/envs/testbed/lib/python3.6/site-packages (from Django==3.1) (3.4.1)\nRequirement already satisfied: pytz in /opt/miniconda3/envs/testbed/lib/python3.6/site-packages (from Django==3.1) (2024.2)\nRequirement already satisfied: sqlparse>=0.2.2 in /opt/miniconda3/envs/testbed/lib/python3.6/site-packages (from Django==3.1) (0.4.4)\nRequirement already satisfied: typing-extensions in /opt/miniconda3/envs/testbed/lib/python3.6/site-packages (from asgiref>=3.2->Django==3.1) (4.1.1)\nInstalling collected packages: Django\n  Attempting uninstall: Django\n    Found existing installation: Django 3.1\n    Uninstalling Django-3.1:\n      Successfully uninstalled Django-3.1\n  Running setup.py develop for Django\nSuccessfully installed Django-3.1\nTesting against Django installed in '/testbed/django'\nImporting application admin_utils\nSkipping setup of unused database(s): other.\nOperations to perform:\n  Synchronize unmigrated apps: admin_utils, auth, contenttypes, messages, sessions, staticfiles\n  Apply all migrations: admin, sites\nSynchronizing apps without migrations:\n  Creating tables...\n    Creating table django_content_type\n    Creating table auth_permission\n    Creating table auth_group\n    Creating table auth_user\n    Creating table django_session\n    Creating table admin_utils_site\n    Creating table admin_utils_article\n    Creating table admin_utils_count\n    Creating table admin_utils_event\n    Creating table admin_utils_location\n    Creating table admin_utils_guest\n    Creating table admin_utils_eventguide\n    Creating table admin_utils_vehicle\n    Creating table admin_utils_car\n    Running deferred SQL...\nRunning migrations:\n  Applying admin.0001_initial... OK\n  Applying admin.0002_logentry_remove_auto_add... OK\n  Applying admin.0003_logentry_add_action_flag_choices... OK\n  Applying sites.0001_initial... OK\n  Applying sites.0002_alter_domain_unique... OK\nSystem check identified no issues (0 silenced).\n", {}]