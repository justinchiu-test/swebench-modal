[{"repo": "django/django", "instance_id": "django__django-12184", "base_commit": "5d674eac871a306405b0fbbaeb17bbeba9c68bf3", "patch": "diff --git a/django/urls/resolvers.py b/django/urls/resolvers.py\n--- a/django/urls/resolvers.py\n+++ b/django/urls/resolvers.py\n@@ -158,8 +158,9 @@ def match(self, path):\n             # If there are any named groups, use those as kwargs, ignoring\n             # non-named groups. Otherwise, pass all non-named arguments as\n             # positional arguments.\n-            kwargs = {k: v for k, v in match.groupdict().items() if v is not None}\n+            kwargs = match.groupdict()\n             args = () if kwargs else match.groups()\n+            kwargs = {k: v for k, v in kwargs.items() if v is not None}\n             return path[match.end():], args, kwargs\n         return None\n \n", "test_patch": "diff --git a/tests/urlpatterns/path_urls.py b/tests/urlpatterns/path_urls.py\n--- a/tests/urlpatterns/path_urls.py\n+++ b/tests/urlpatterns/path_urls.py\n@@ -12,6 +12,11 @@\n     path('included_urls/', include('urlpatterns.included_urls')),\n     re_path(r'^regex/(?P<pk>[0-9]+)/$', views.empty_view, name='regex'),\n     re_path(r'^regex_optional/(?P<arg1>\\d+)/(?:(?P<arg2>\\d+)/)?', views.empty_view, name='regex_optional'),\n+    re_path(\n+        r'^regex_only_optional/(?:(?P<arg1>\\d+)/)?',\n+        views.empty_view,\n+        name='regex_only_optional',\n+    ),\n     path('', include('urlpatterns.more_urls')),\n     path('<lang>/<path:url>/', views.empty_view, name='lang-and-path'),\n ]\ndiff --git a/tests/urlpatterns/tests.py b/tests/urlpatterns/tests.py\n--- a/tests/urlpatterns/tests.py\n+++ b/tests/urlpatterns/tests.py\n@@ -68,6 +68,16 @@ def test_re_path_with_optional_parameter(self):\n                     r'^regex_optional/(?P<arg1>\\d+)/(?:(?P<arg2>\\d+)/)?',\n                 )\n \n+    def test_re_path_with_missing_optional_parameter(self):\n+        match = resolve('/regex_only_optional/')\n+        self.assertEqual(match.url_name, 'regex_only_optional')\n+        self.assertEqual(match.kwargs, {})\n+        self.assertEqual(match.args, ())\n+        self.assertEqual(\n+            match.route,\n+            r'^regex_only_optional/(?:(?P<arg1>\\d+)/)?',\n+        )\n+\n     def test_path_lookup_with_inclusion(self):\n         match = resolve('/included_urls/extra/something/')\n         self.assertEqual(match.url_name, 'inner-extra')\n", "problem_statement": "Optional URL params crash some view functions.\nDescription\n\t\nMy use case, running fine with Django until 2.2:\nURLConf:\nurlpatterns += [\n\t...\n\tre_path(r'^module/(?P<format>(html|json|xml))?/?$', views.modules, name='modules'),\n]\nView:\ndef modules(request, format='html'):\n\t...\n\treturn render(...)\nWith Django 3.0, this is now producing an error:\nTraceback (most recent call last):\n File \"/l10n/venv/lib/python3.6/site-packages/django/core/handlers/exception.py\", line 34, in inner\n\tresponse = get_response(request)\n File \"/l10n/venv/lib/python3.6/site-packages/django/core/handlers/base.py\", line 115, in _get_response\n\tresponse = self.process_exception_by_middleware(e, request)\n File \"/l10n/venv/lib/python3.6/site-packages/django/core/handlers/base.py\", line 113, in _get_response\n\tresponse = wrapped_callback(request, *callback_args, **callback_kwargs)\nException Type: TypeError at /module/\nException Value: modules() takes from 1 to 2 positional arguments but 3 were given\n", "hints_text": "Tracked regression in 76b993a117b61c41584e95149a67d8a1e9f49dd1.\nIt seems to work if you remove the extra parentheses: re_path(r'^module/(?P<format>html|json|xml)?/?$', views.modules, name='modules'), It seems Django is getting confused by the nested groups.", "created_at": "2019-12-05T13:09:48Z", "version": "3.1", "FAIL_TO_PASS": "[\"test_re_path_with_missing_optional_parameter (urlpatterns.tests.SimplifiedURLTests)\"]", "PASS_TO_PASS": "[\"test_allows_non_ascii_but_valid_identifiers (urlpatterns.tests.ParameterRestrictionTests)\", \"test_non_identifier_parameter_name_causes_exception (urlpatterns.tests.ParameterRestrictionTests)\", \"test_matching_urls (urlpatterns.tests.ConverterTests)\", \"test_nonmatching_urls (urlpatterns.tests.ConverterTests)\", \"test_resolve_type_error_propagates (urlpatterns.tests.ConversionExceptionTests)\", \"test_resolve_value_error_means_no_match (urlpatterns.tests.ConversionExceptionTests)\", \"test_reverse_value_error_propagates (urlpatterns.tests.ConversionExceptionTests)\", \"test_converter_resolve (urlpatterns.tests.SimplifiedURLTests)\", \"test_converter_reverse (urlpatterns.tests.SimplifiedURLTests)\", \"test_converter_reverse_with_second_layer_instance_namespace (urlpatterns.tests.SimplifiedURLTests)\", \"test_invalid_converter (urlpatterns.tests.SimplifiedURLTests)\", \"test_path_inclusion_is_matchable (urlpatterns.tests.SimplifiedURLTests)\", \"test_path_inclusion_is_reversible (urlpatterns.tests.SimplifiedURLTests)\", \"test_path_lookup_with_double_inclusion (urlpatterns.tests.SimplifiedURLTests)\", \"test_path_lookup_with_empty_string_inclusion (urlpatterns.tests.SimplifiedURLTests)\", \"test_path_lookup_with_inclusion (urlpatterns.tests.SimplifiedURLTests)\", \"test_path_lookup_with_multiple_parameters (urlpatterns.tests.SimplifiedURLTests)\", \"test_path_lookup_with_typed_parameters (urlpatterns.tests.SimplifiedURLTests)\", \"test_path_lookup_without_parameters (urlpatterns.tests.SimplifiedURLTests)\", \"test_path_reverse_with_parameter (urlpatterns.tests.SimplifiedURLTests)\", \"test_path_reverse_without_parameter (urlpatterns.tests.SimplifiedURLTests)\", \"test_re_path (urlpatterns.tests.SimplifiedURLTests)\", \"test_re_path_with_optional_parameter (urlpatterns.tests.SimplifiedURLTests)\", \"test_space_in_route (urlpatterns.tests.SimplifiedURLTests)\", \"test_two_variable_at_start_of_path_pattern (urlpatterns.tests.SimplifiedURLTests)\"]", "environment_setup_commit": "0668164b4ac93a5be79f5b87fae83c657124d9ab"}, "Generating locales (this might take a while)...\n  en_US.UTF-8... done\nGeneration complete.\nOn branch main\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   django/urls/resolvers.py\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")\ncommit 5d674eac871a306405b0fbbaeb17bbeba9c68bf3\nAuthor: Hasan Ramezani <hasan.r67@gmail.com>\nDate:   Thu Dec 5 09:54:27 2019 +0100\n\n    Fixed #31039 -- Added support for contained_by lookup with AutoFields, SmallIntegerField, and DecimalField.\n\ndiff --git a/django/contrib/postgres/fields/ranges.py b/django/contrib/postgres/fields/ranges.py\nindex b0b9275622..9a89fda02d 100644\n--- a/django/contrib/postgres/fields/ranges.py\n+++ b/django/contrib/postgres/fields/ranges.py\n@@ -199,9 +199,11 @@ DateTimeRangeField.register_lookup(DateTimeRangeContains)\n class RangeContainedBy(lookups.PostgresSimpleLookup):\n     lookup_name = 'contained_by'\n     type_mapping = {\n+        'smallint': 'int4range',\n         'integer': 'int4range',\n         'bigint': 'int8range',\n         'double precision': 'numrange',\n+        'numeric': 'numrange',\n         'date': 'daterange',\n         'timestamp with time zone': 'tstzrange',\n     }\n@@ -209,13 +211,17 @@ class RangeContainedBy(lookups.PostgresSimpleLookup):\n \n     def process_rhs(self, compiler, connection):\n         rhs, rhs_params = super().process_rhs(compiler, connection)\n-        cast_type = self.type_mapping[self.lhs.output_field.db_type(connection)]\n+        # Ignore precision for DecimalFields.\n+        db_type = self.lhs.output_field.cast_db_type(connection).split('(')[0]\n+        cast_type = self.type_mapping[db_type]\n         return '%s::%s' % (rhs, cast_type), rhs_params\n \n     def process_lhs(self, compiler, connection):\n         lhs, lhs_params = super().process_lhs(compiler, connection)\n         if isinstance(self.lhs.output_field, models.FloatField):\n             lhs = '%s::numeric' % lhs\n+        elif isinstance(self.lhs.output_field, models.SmallIntegerField):\n+            lhs = '%s::integer' % lhs\n         return lhs, lhs_params\n \n     def get_prep_lookup(self):\n@@ -226,6 +232,7 @@ models.DateField.register_lookup(RangeContainedBy)\n models.DateTimeField.register_lookup(RangeContainedBy)\n models.IntegerField.register_lookup(RangeContainedBy)\n models.FloatField.register_lookup(RangeContainedBy)\n+models.DecimalField.register_lookup(RangeContainedBy)\n \n \n @RangeField.register_lookup\ndiff --git a/docs/ref/contrib/postgres/fields.txt b/docs/ref/contrib/postgres/fields.txt\nindex cd35a33ee6..e8fcef6215 100644\n--- a/docs/ref/contrib/postgres/fields.txt\n+++ b/docs/ref/contrib/postgres/fields.txt\n@@ -738,10 +738,14 @@ operators ``@>``, ``<@``, and ``&&`` respectively.\n     <QuerySet [<Event: Soft play>]>\n \n The ``contained_by`` lookup is also available on the non-range field types:\n+:class:`~django.db.models.SmallAutoField`,\n+:class:`~django.db.models.AutoField`, :class:`~django.db.models.BigAutoField`,\n+:class:`~django.db.models.SmallIntegerField`,\n :class:`~django.db.models.IntegerField`,\n :class:`~django.db.models.BigIntegerField`,\n-:class:`~django.db.models.FloatField`, :class:`~django.db.models.DateField`,\n-and :class:`~django.db.models.DateTimeField`. For example::\n+:class:`~django.db.models.DecimalField`, :class:`~django.db.models.FloatField`,\n+:class:`~django.db.models.DateField`, and\n+:class:`~django.db.models.DateTimeField`. For example::\n \n     >>> from psycopg2.extras import DateTimeTZRange\n     >>> Event.objects.filter(start__contained_by=DateTimeTZRange(\n@@ -750,6 +754,14 @@ and :class:`~django.db.models.DateTimeField`. For example::\n     ... )\n     <QuerySet [<Event: Soft play>]>\n \n+.. versionchanged:: 3.1\n+\n+    Support for :class:`~django.db.models.SmallAutoField`,\n+    :class:`~django.db.models.AutoField`,\n+    :class:`~django.db.models.BigAutoField`,\n+    :class:`~django.db.models.SmallIntegerField`, and\n+    :class:`~django.db.models.DecimalField` was added.\n+\n .. fieldlookup:: rangefield.overlap\n \n ``overlap``\ndiff --git a/docs/releases/3.1.txt b/docs/releases/3.1.txt\nindex 631978d0ac..ec107bf29b 100644\n--- a/docs/releases/3.1.txt\n+++ b/docs/releases/3.1.txt\n@@ -90,6 +90,13 @@ Minor features\n   :lookup:`rangefield.upper_inc`, and :lookup:`rangefield.upper_inf` allows\n   querying :class:`~django.contrib.postgres.fields.RangeField` by a bound type.\n \n+* :lookup:`rangefield.contained_by` now supports\n+  :class:`~django.db.models.SmallAutoField`,\n+  :class:`~django.db.models.AutoField`,\n+  :class:`~django.db.models.BigAutoField`,\n+  :class:`~django.db.models.SmallIntegerField`, and\n+  :class:`~django.db.models.DecimalField`.\n+\n :mod:`django.contrib.redirects`\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n \ndiff --git a/tests/postgres_tests/migrations/0002_create_test_models.py b/tests/postgres_tests/migrations/0002_create_test_models.py\nindex 0e36cd1256..12d94e348a 100644\n--- a/tests/postgres_tests/migrations/0002_create_test_models.py\n+++ b/tests/postgres_tests/migrations/0002_create_test_models.py\n@@ -124,6 +124,20 @@ class Migration(migrations.Migration):\n             options=None,\n             bases=None,\n         ),\n+        migrations.CreateModel(\n+            name='SmallAutoFieldModel',\n+            fields=[\n+                ('id', models.SmallAutoField(verbose_name='ID', serialize=False, primary_key=True)),\n+            ],\n+            options=None,\n+        ),\n+        migrations.CreateModel(\n+            name='BigAutoFieldModel',\n+            fields=[\n+                ('id', models.BigAutoField(verbose_name='ID', serialize=False, primary_key=True)),\n+            ],\n+            options=None,\n+        ),\n         migrations.CreateModel(\n             name='Scene',\n             fields=[\n@@ -237,6 +251,8 @@ class Migration(migrations.Migration):\n                 ('float', models.FloatField(blank=True, null=True)),\n                 ('timestamp', models.DateTimeField(blank=True, null=True)),\n                 ('date', models.DateField(blank=True, null=True)),\n+                ('small_integer', models.SmallIntegerField(blank=True, null=True)),\n+                ('decimal_field', models.DecimalField(max_digits=5, decimal_places=2, blank=True, null=True)),\n             ],\n             options={\n                 'required_db_vendor': 'postgresql',\ndiff --git a/tests/postgres_tests/models.py b/tests/postgres_tests/models.py\nindex 2cf47b88c7..8528c59da1 100644\n--- a/tests/postgres_tests/models.py\n+++ b/tests/postgres_tests/models.py\n@@ -93,6 +93,14 @@ class TextFieldModel(models.Model):\n         return self.field\n \n \n+class SmallAutoFieldModel(models.Model):\n+    id = models.SmallAutoField(primary_key=True)\n+\n+\n+class BigAutoFieldModel(models.Model):\n+    id = models.BigAutoField(primary_key=True)\n+\n+\n # Scene/Character/Line models are used to test full text search. They're\n # populated with content from Monty Python and the Holy Grail.\n class Scene(models.Model):\n@@ -148,6 +156,8 @@ class RangeLookupsModel(PostgreSQLModel):\n     float = models.FloatField(blank=True, null=True)\n     timestamp = models.DateTimeField(blank=True, null=True)\n     date = models.DateField(blank=True, null=True)\n+    small_integer = models.SmallIntegerField(blank=True, null=True)\n+    decimal_field = models.DecimalField(max_digits=5, decimal_places=2, blank=True, null=True)\n \n \n class JSONModel(PostgreSQLModel):\ndiff --git a/tests/postgres_tests/test_ranges.py b/tests/postgres_tests/test_ranges.py\nindex 789ff3d546..7257d66505 100644\n--- a/tests/postgres_tests/test_ranges.py\n+++ b/tests/postgres_tests/test_ranges.py\n@@ -11,7 +11,10 @@ from django.test.utils import isolate_apps\n from django.utils import timezone\n \n from . import PostgreSQLSimpleTestCase, PostgreSQLTestCase\n-from .models import PostgreSQLModel, RangeLookupsModel, RangesModel\n+from .models import (\n+    BigAutoFieldModel, PostgreSQLModel, RangeLookupsModel, RangesModel,\n+    SmallAutoFieldModel,\n+)\n \n try:\n     from psycopg2.extras import DateRange, DateTimeTZRange, NumericRange\n@@ -354,6 +357,17 @@ class TestQueryingWithRanges(PostgreSQLTestCase):\n             [objs[0]],\n         )\n \n+    def test_small_integer_field_contained_by(self):\n+        objs = [\n+            RangeLookupsModel.objects.create(small_integer=8),\n+            RangeLookupsModel.objects.create(small_integer=4),\n+            RangeLookupsModel.objects.create(small_integer=-1),\n+        ]\n+        self.assertSequenceEqual(\n+            RangeLookupsModel.objects.filter(small_integer__contained_by=NumericRange(4, 6)),\n+            [objs[1]],\n+        )\n+\n     def test_integer_range(self):\n         objs = [\n             RangeLookupsModel.objects.create(integer=5),\n@@ -376,6 +390,19 @@ class TestQueryingWithRanges(PostgreSQLTestCase):\n             [objs[0]]\n         )\n \n+    def test_decimal_field_contained_by(self):\n+        objs = [\n+            RangeLookupsModel.objects.create(decimal_field=Decimal('1.33')),\n+            RangeLookupsModel.objects.create(decimal_field=Decimal('2.88')),\n+            RangeLookupsModel.objects.create(decimal_field=Decimal('99.17')),\n+        ]\n+        self.assertSequenceEqual(\n+            RangeLookupsModel.objects.filter(\n+                decimal_field__contained_by=NumericRange(Decimal('1.89'), Decimal('7.91')),\n+            ),\n+            [objs[1]],\n+        )\n+\n     def test_float_range(self):\n         objs = [\n             RangeLookupsModel.objects.create(float=5),\n@@ -387,6 +414,39 @@ class TestQueryingWithRanges(PostgreSQLTestCase):\n             [objs[0]]\n         )\n \n+    def test_small_auto_field_contained_by(self):\n+        objs = SmallAutoFieldModel.objects.bulk_create([\n+            SmallAutoFieldModel() for i in range(1, 5)\n+        ])\n+        self.assertSequenceEqual(\n+            SmallAutoFieldModel.objects.filter(\n+                id__contained_by=NumericRange(objs[1].pk, objs[3].pk),\n+            ),\n+            objs[1:3],\n+        )\n+\n+    def test_auto_field_contained_by(self):\n+        objs = RangeLookupsModel.objects.bulk_create([\n+            RangeLookupsModel() for i in range(1, 5)\n+        ])\n+        self.assertSequenceEqual(\n+            RangeLookupsModel.objects.filter(\n+                id__contained_by=NumericRange(objs[1].pk, objs[3].pk),\n+            ),\n+            objs[1:3],\n+        )\n+\n+    def test_big_auto_field_contained_by(self):\n+        objs = BigAutoFieldModel.objects.bulk_create([\n+            BigAutoFieldModel() for i in range(1, 5)\n+        ])\n+        self.assertSequenceEqual(\n+            BigAutoFieldModel.objects.filter(\n+                id__contained_by=NumericRange(objs[1].pk, objs[3].pk),\n+            ),\n+            objs[1:3],\n+        )\n+\n     def test_f_ranges(self):\n         parent = RangesModel.objects.create(decimals=NumericRange(0, 10))\n         objs = [\ndiff --git a/django/urls/resolvers.py b/django/urls/resolvers.py\nindex 2d4610aac4..120e0396af 100644\n--- a/django/urls/resolvers.py\n+++ b/django/urls/resolvers.py\n@@ -158,8 +158,9 @@ class RegexPattern(CheckURLMixin):\n             # If there are any named groups, use those as kwargs, ignoring\n             # non-named groups. Otherwise, pass all non-named arguments as\n             # positional arguments.\n-            kwargs = {k: v for k, v in match.groupdict().items() if v is not None}\n+            kwargs = match.groupdict()\n             args = () if kwargs else match.groups()\n+            kwargs = {k: v for k, v in kwargs.items() if v is not None}\n             return path[match.end():], args, kwargs\n         return None\n \nObtaining file:///testbed\nRequirement already satisfied: asgiref>=3.2 in /opt/miniconda3/envs/testbed/lib/python3.6/site-packages (from Django==3.1) (3.4.1)\nRequirement already satisfied: pytz in /opt/miniconda3/envs/testbed/lib/python3.6/site-packages (from Django==3.1) (2024.2)\nRequirement already satisfied: sqlparse>=0.2.2 in /opt/miniconda3/envs/testbed/lib/python3.6/site-packages (from Django==3.1) (0.4.4)\nRequirement already satisfied: typing-extensions in /opt/miniconda3/envs/testbed/lib/python3.6/site-packages (from asgiref>=3.2->Django==3.1) (4.1.1)\nInstalling collected packages: Django\n  Attempting uninstall: Django\n    Found existing installation: Django 3.1\n    Uninstalling Django-3.1:\n      Successfully uninstalled Django-3.1\n  Running setup.py develop for Django\nSuccessfully installed Django-3.1\nTesting against Django installed in '/testbed/django'\nImporting application urlpatterns\nSkipping setup of unused database(s): default, other.\nSystem check identified no issues (0 silenced).\n", {}]