[{"repo": "django/django", "instance_id": "django__django-14580", "base_commit": "36fa071d6ebd18a61c4d7f1b5c9d17106134bd44", "patch": "diff --git a/django/db/migrations/serializer.py b/django/db/migrations/serializer.py\n--- a/django/db/migrations/serializer.py\n+++ b/django/db/migrations/serializer.py\n@@ -273,7 +273,7 @@ def _format(self):\n class TypeSerializer(BaseSerializer):\n     def serialize(self):\n         special_cases = [\n-            (models.Model, \"models.Model\", []),\n+            (models.Model, \"models.Model\", ['from django.db import models']),\n             (type(None), 'type(None)', []),\n         ]\n         for case, string, imports in special_cases:\n", "test_patch": "diff --git a/tests/migrations/test_writer.py b/tests/migrations/test_writer.py\n--- a/tests/migrations/test_writer.py\n+++ b/tests/migrations/test_writer.py\n@@ -658,6 +658,13 @@ def test_serialize_functools_partialmethod(self):\n     def test_serialize_type_none(self):\n         self.assertSerializedEqual(type(None))\n \n+    def test_serialize_type_model(self):\n+        self.assertSerializedEqual(models.Model)\n+        self.assertSerializedResultEqual(\n+            MigrationWriter.serialize(models.Model),\n+            (\"('models.Model', {'from django.db import models'})\", set()),\n+        )\n+\n     def test_simple_migration(self):\n         \"\"\"\n         Tests serializing a simple migration.\n", "problem_statement": "Missing import statement in generated migration (NameError: name 'models' is not defined)\nDescription\n\t\nI found a bug in Django's latest release: 3.2.4. \nGiven the following contents of models.py:\nfrom django.db import models\nclass MyField(models.TextField):\n\tpass\nclass MyBaseModel(models.Model):\n\tclass Meta:\n\t\tabstract = True\nclass MyMixin:\n\tpass\nclass MyModel(MyMixin, MyBaseModel):\n\tname = MyField(primary_key=True)\nThe makemigrations command will generate the following migration file:\n# Generated by Django 3.2.4 on 2021-06-30 19:13\nimport app.models\nfrom django.db import migrations\nclass Migration(migrations.Migration):\n\tinitial = True\n\tdependencies = [\n\t]\n\toperations = [\n\t\tmigrations.CreateModel(\n\t\t\tname='MyModel',\n\t\t\tfields=[\n\t\t\t\t('name', app.models.MyField(primary_key=True, serialize=False)),\n\t\t\t],\n\t\t\toptions={\n\t\t\t\t'abstract': False,\n\t\t\t},\n\t\t\tbases=(app.models.MyMixin, models.Model),\n\t\t),\n\t]\nWhich will then fail with the following error:\n File \"/home/jj/django_example/app/migrations/0001_initial.py\", line 7, in <module>\n\tclass Migration(migrations.Migration):\n File \"/home/jj/django_example/app/migrations/0001_initial.py\", line 23, in Migration\n\tbases=(app.models.MyMixin, models.Model),\nNameError: name 'models' is not defined\nExpected behavior: Django generates a migration file that is valid Python.\nActual behavior: Django generates a migration file that is missing an import statement.\nI think this is a bug of the module django.db.migrations.writer, but I'm not sure. I will be happy to assist with debugging.\nThanks for your attention,\nJaap Joris\n", "hints_text": "I could reproduce the issue with 3.2.4, 2.2.24 and the main branch. For what it's worth, the issue doesn't occur if the class MyModel does inherit from MyMixin.\nMyBaseModel is not necessary to reproduce this issue, it's due to the fact that MyModel doesn't have fields from django.db.models and has custom bases. It looks like an issue with special casing of models.Model in TypeSerializer. Proposed patch diff --git a/django/db/migrations/serializer.py b/django/db/migrations/serializer.py index e19c881cda..6e78462e95 100644 --- a/django/db/migrations/serializer.py +++ b/django/db/migrations/serializer.py @@ -273,7 +273,7 @@ class TupleSerializer(BaseSequenceSerializer): class TypeSerializer(BaseSerializer): def serialize(self): special_cases = [ - (models.Model, \"models.Model\", []), + (models.Model, \"models.Model\", ['from django.db import models']), (type(None), 'type(None)', []), ] for case, string, imports in special_cases:", "created_at": "2021-07-01T07:38:03Z", "version": "4.0", "FAIL_TO_PASS": "[\"test_serialize_type_model (migrations.test_writer.WriterTests)\"]", "PASS_TO_PASS": "[\"test_args_kwargs_signature (migrations.test_writer.OperationWriterTests)\", \"test_args_signature (migrations.test_writer.OperationWriterTests)\", \"test_empty_signature (migrations.test_writer.OperationWriterTests)\", \"test_expand_args_signature (migrations.test_writer.OperationWriterTests)\", \"test_kwargs_signature (migrations.test_writer.OperationWriterTests)\", \"test_multiline_args_signature (migrations.test_writer.OperationWriterTests)\", \"test_nested_args_signature (migrations.test_writer.OperationWriterTests)\", \"test_nested_operation_expand_args_signature (migrations.test_writer.OperationWriterTests)\", \"test_custom_operation (migrations.test_writer.WriterTests)\", \"test_deconstruct_class_arguments (migrations.test_writer.WriterTests)\", \"Test comments at top of file.\", \"test_migration_path (migrations.test_writer.WriterTests)\", \"django.db.models shouldn't be imported if unused.\", \"test_register_non_serializer (migrations.test_writer.WriterTests)\", \"test_register_serializer (migrations.test_writer.WriterTests)\", \"test_serialize_builtin_types (migrations.test_writer.WriterTests)\", \"test_serialize_builtins (migrations.test_writer.WriterTests)\", \"test_serialize_choices (migrations.test_writer.WriterTests)\", \"Ticket #22943: Test serialization of class-based validators, including\", \"test_serialize_collections (migrations.test_writer.WriterTests)\", \"Make sure compiled regex can be serialized.\", \"test_serialize_constants (migrations.test_writer.WriterTests)\", \"test_serialize_datetime (migrations.test_writer.WriterTests)\", \"Ticket #22679: makemigrations generates invalid code for (an empty\", \"test_serialize_enums (migrations.test_writer.WriterTests)\", \"test_serialize_fields (migrations.test_writer.WriterTests)\", \"test_serialize_frozensets (migrations.test_writer.WriterTests)\", \"test_serialize_functions (migrations.test_writer.WriterTests)\", \"test_serialize_functools_partial (migrations.test_writer.WriterTests)\", \"test_serialize_functools_partialmethod (migrations.test_writer.WriterTests)\", \"test_serialize_iterators (migrations.test_writer.WriterTests)\", \"test_serialize_lazy_objects (migrations.test_writer.WriterTests)\", \"A reference in a local scope can't be serialized.\", \"test_serialize_managers (migrations.test_writer.WriterTests)\", \"test_serialize_multiline_strings (migrations.test_writer.WriterTests)\", \"test_serialize_nested_class (migrations.test_writer.WriterTests)\", \"test_serialize_numbers (migrations.test_writer.WriterTests)\", \"test_serialize_path_like (migrations.test_writer.WriterTests)\", \"test_serialize_pathlib (migrations.test_writer.WriterTests)\", \"test_serialize_range (migrations.test_writer.WriterTests)\", \"test_serialize_set (migrations.test_writer.WriterTests)\", \"test_serialize_settings (migrations.test_writer.WriterTests)\", \"test_serialize_strings (migrations.test_writer.WriterTests)\", \"test_serialize_timedelta (migrations.test_writer.WriterTests)\", \"test_serialize_type_none (migrations.test_writer.WriterTests)\", \"An unbound method used within a class body can be serialized.\", \"test_serialize_uuid (migrations.test_writer.WriterTests)\", \"Tests serializing a simple migration.\", \"#24155 - Tests ordering of imports.\"]", "environment_setup_commit": "475cffd1d64c690cdad16ede4d5e81985738ceb4"}, "On branch main\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   django/db/migrations/serializer.py\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")\ncommit 36fa071d6ebd18a61c4d7f1b5c9d17106134bd44\nAuthor: Allan Feldman <afeldman@newrelic.com>\nDate:   Wed Jun 30 17:37:10 2021 +0200\n\n    Fixed #32889 -- Allowed per-request sync_to_async context in ASGIHandler .\n    \n    By using a asgiref's ThreadSensitiveContext context manager, requests\n    will be able to execute independently of other requests when sync work\n    is involved.\n    \n    Prior to this commit, a single global thread was used to execute any\n    sync work independent of the request from which that work was scheduled.\n    This could result in contention for the global sync thread in the case\n    of a slow sync function.\n    \n    Requests are now isolated to their own sync thread.\n\ndiff --git a/django/core/handlers/asgi.py b/django/core/handlers/asgi.py\nindex 7fbabe4510..2b8cc8b76e 100644\n--- a/django/core/handlers/asgi.py\n+++ b/django/core/handlers/asgi.py\n@@ -3,7 +3,7 @@ import sys\n import tempfile\n import traceback\n \n-from asgiref.sync import sync_to_async\n+from asgiref.sync import ThreadSensitiveContext, sync_to_async\n \n from django.conf import settings\n from django.core import signals\n@@ -144,6 +144,14 @@ class ASGIHandler(base.BaseHandler):\n                 'Django can only handle ASGI/HTTP connections, not %s.'\n                 % scope['type']\n             )\n+\n+        async with ThreadSensitiveContext():\n+            await self.handle(scope, receive, send)\n+\n+    async def handle(self, scope, receive, send):\n+        \"\"\"\n+        Handles the ASGI request. Called via the __call__ method.\n+        \"\"\"\n         # Receive the HTTP request body as a stream object.\n         try:\n             body_file = await self.read_body(receive)\ndiff --git a/tests/asgi/tests.py b/tests/asgi/tests.py\nindex 3509bb0aa7..7eb35724df 100644\n--- a/tests/asgi/tests.py\n+++ b/tests/asgi/tests.py\n@@ -4,7 +4,6 @@ import threading\n from pathlib import Path\n from unittest import skipIf\n \n-from asgiref.sync import SyncToAsync\n from asgiref.testing import ApplicationCommunicator\n \n from django.contrib.staticfiles.handlers import ASGIStaticFilesHandler\n@@ -16,7 +15,7 @@ from django.test import (\n )\n from django.utils.http import http_date\n \n-from .urls import test_filename\n+from .urls import sync_waiter, test_filename\n \n TEST_STATIC_ROOT = Path(__file__).parent / 'project' / 'static'\n \n@@ -235,11 +234,39 @@ class ASGITest(SimpleTestCase):\n         # Give response.close() time to finish.\n         await communicator.wait()\n \n-        # At this point, AsyncToSync does not have a current executor. Thus\n-        # SyncToAsync falls-back to .single_thread_executor.\n-        target_thread = next(iter(SyncToAsync.single_thread_executor._threads))\n+        # AsyncToSync should have executed the signals in the same thread.\n         request_started_thread, request_finished_thread = signal_handler.threads\n-        self.assertEqual(request_started_thread, target_thread)\n-        self.assertEqual(request_finished_thread, target_thread)\n+        self.assertEqual(request_started_thread, request_finished_thread)\n         request_started.disconnect(signal_handler)\n         request_finished.disconnect(signal_handler)\n+\n+    async def test_concurrent_async_uses_multiple_thread_pools(self):\n+        sync_waiter.active_threads.clear()\n+\n+        # Send 2 requests concurrently\n+        application = get_asgi_application()\n+        scope = self.async_request_factory._base_scope(path='/wait/')\n+        communicators = []\n+        for _ in range(2):\n+            communicators.append(ApplicationCommunicator(application, scope))\n+            await communicators[-1].send_input({'type': 'http.request'})\n+\n+        # Each request must complete with a status code of 200\n+        # If requests aren't scheduled concurrently, the barrier in the\n+        # sync_wait view will time out, resulting in a 500 status code.\n+        for communicator in communicators:\n+            response_start = await communicator.receive_output()\n+            self.assertEqual(response_start['type'], 'http.response.start')\n+            self.assertEqual(response_start['status'], 200)\n+            response_body = await communicator.receive_output()\n+            self.assertEqual(response_body['type'], 'http.response.body')\n+            self.assertEqual(response_body['body'], b'Hello World!')\n+            # Give response.close() time to finish.\n+            await communicator.wait()\n+\n+        # The requests should have scheduled on different threads. Note\n+        # active_threads is a set (a thread can only appear once), therefore\n+        # length is a sufficient check.\n+        self.assertEqual(len(sync_waiter.active_threads), 2)\n+\n+        sync_waiter.active_threads.clear()\ndiff --git a/tests/asgi/urls.py b/tests/asgi/urls.py\nindex ff8d21ea7c..22d85604d1 100644\n--- a/tests/asgi/urls.py\n+++ b/tests/asgi/urls.py\n@@ -1,3 +1,5 @@\n+import threading\n+\n from django.http import FileResponse, HttpResponse\n from django.urls import path\n \n@@ -14,6 +16,18 @@ def hello_meta(request):\n     )\n \n \n+def sync_waiter(request):\n+    with sync_waiter.lock:\n+        sync_waiter.active_threads.add(threading.current_thread())\n+    sync_waiter.barrier.wait(timeout=0.5)\n+    return hello(request)\n+\n+\n+sync_waiter.active_threads = set()\n+sync_waiter.lock = threading.Lock()\n+sync_waiter.barrier = threading.Barrier(2)\n+\n+\n test_filename = __file__\n \n \n@@ -21,4 +35,5 @@ urlpatterns = [\n     path('', hello),\n     path('file/', lambda x: FileResponse(open(test_filename, 'rb'))),\n     path('meta/', hello_meta),\n+    path('wait/', sync_waiter),\n ]\ndiff --git a/django/db/migrations/serializer.py b/django/db/migrations/serializer.py\nindex e19c881cda..6e78462e95 100644\n--- a/django/db/migrations/serializer.py\n+++ b/django/db/migrations/serializer.py\n@@ -273,7 +273,7 @@ class TupleSerializer(BaseSequenceSerializer):\n class TypeSerializer(BaseSerializer):\n     def serialize(self):\n         special_cases = [\n-            (models.Model, \"models.Model\", []),\n+            (models.Model, \"models.Model\", ['from django.db import models']),\n             (type(None), 'type(None)', []),\n         ]\n         for case, string, imports in special_cases:\nObtaining file:///testbed\n  Installing build dependencies: started\n  Installing build dependencies: finished with status 'done'\n  Checking if build backend supports build_editable: started\n  Checking if build backend supports build_editable: finished with status 'done'\n  Getting requirements to build editable: started\n  Getting requirements to build editable: finished with status 'done'\n  Preparing editable metadata (pyproject.toml): started\n  Preparing editable metadata (pyproject.toml): finished with status 'done'\nRequirement already satisfied: asgiref>=3.3.2 in /opt/miniconda3/envs/testbed/lib/python3.8/site-packages (from Django==4.0.dev20210701101319) (3.8.1)\nRequirement already satisfied: pytz in /opt/miniconda3/envs/testbed/lib/python3.8/site-packages (from Django==4.0.dev20210701101319) (2024.2)\nRequirement already satisfied: sqlparse>=0.2.2 in /opt/miniconda3/envs/testbed/lib/python3.8/site-packages (from Django==4.0.dev20210701101319) (0.5.1)\nRequirement already satisfied: typing-extensions>=4 in /opt/miniconda3/envs/testbed/lib/python3.8/site-packages (from asgiref>=3.3.2->Django==4.0.dev20210701101319) (4.12.2)\nBuilding wheels for collected packages: Django\n  Building editable for Django (pyproject.toml): started\n  Building editable for Django (pyproject.toml): finished with status 'done'\n  Created wheel for Django: filename=Django-4.0.dev20210701101319-0.editable-py3-none-any.whl size=26188 sha256=120e580446b2165c1207b437ec01e3296256309e46cdcc9853d0791e089cd5f4\n  Stored in directory: /tmp/pip-ephem-wheel-cache-btcdk1d9/wheels/b2/50/f1/218f2e9962a80d01a4b1297698978f9fb3b60056aa24343f24\nSuccessfully built Django\nInstalling collected packages: Django\n  Attempting uninstall: Django\n    Found existing installation: Django 4.0.dev20210701101319\n    Uninstalling Django-4.0.dev20210701101319:\n      Successfully uninstalled Django-4.0.dev20210701101319\nSuccessfully installed Django-4.0.dev20210701101319\nTesting against Django installed in '/testbed/django'\nImporting application migrations\nFound 50 test(s).\nSkipping setup of unused database(s): default, other.\nSystem check identified no issues (0 silenced).\n", {}]