[{"repo": "django/django", "instance_id": "django__django-16408", "base_commit": "ef85b6bf0bc5a8b194f0724cf5bbedbcee402b96", "patch": "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -1274,6 +1274,9 @@ def local_setter(final_field, obj, from_obj):\n                 if from_obj:\n                     final_field.remote_field.set_cached_value(from_obj, obj)\n \n+            def local_setter_noop(obj, from_obj):\n+                pass\n+\n             def remote_setter(name, obj, from_obj):\n                 setattr(from_obj, name, obj)\n \n@@ -1295,7 +1298,11 @@ def remote_setter(name, obj, from_obj):\n                         \"model\": model,\n                         \"field\": final_field,\n                         \"reverse\": True,\n-                        \"local_setter\": partial(local_setter, final_field),\n+                        \"local_setter\": (\n+                            partial(local_setter, final_field)\n+                            if len(joins) <= 2\n+                            else local_setter_noop\n+                        ),\n                         \"remote_setter\": partial(remote_setter, name),\n                         \"from_parent\": from_parent,\n                     }\n", "test_patch": "diff --git a/tests/known_related_objects/tests.py b/tests/known_related_objects/tests.py\n--- a/tests/known_related_objects/tests.py\n+++ b/tests/known_related_objects/tests.py\n@@ -164,3 +164,23 @@ def test_reverse_fk_select_related_multiple(self):\n             )\n             self.assertIs(ps[0], ps[0].pool_1.poolstyle)\n             self.assertIs(ps[0], ps[0].pool_2.another_style)\n+\n+    def test_multilevel_reverse_fk_cyclic_select_related(self):\n+        with self.assertNumQueries(3):\n+            p = list(\n+                PoolStyle.objects.annotate(\n+                    tournament_pool=FilteredRelation(\"pool__tournament__pool\"),\n+                ).select_related(\"tournament_pool\", \"tournament_pool__tournament\")\n+            )\n+            self.assertEqual(p[0].tournament_pool.tournament, p[0].pool.tournament)\n+\n+    def test_multilevel_reverse_fk_select_related(self):\n+        with self.assertNumQueries(2):\n+            p = list(\n+                Tournament.objects.filter(id=self.t2.id)\n+                .annotate(\n+                    style=FilteredRelation(\"pool__another_style\"),\n+                )\n+                .select_related(\"style\")\n+            )\n+            self.assertEqual(p[0].style.another_pool, self.p3)\n", "problem_statement": "Multi-level FilteredRelation with select_related() may set wrong related object.\nDescription\n\t\ntest case:\n# add to known_related_objects.tests.ExistingRelatedInstancesTests\n\tdef test_wrong_select_related(self):\n\t\twith self.assertNumQueries(3):\n\t\t\tp = list(PoolStyle.objects.annotate(\n\t\t\t\ttournament_pool=FilteredRelation('pool__tournament__pool'),\n\t\t\t\t).select_related('tournament_pool'))\n\t\t\tself.assertEqual(p[0].pool.tournament, p[0].tournament_pool.tournament)\nresult:\n======================================================================\nFAIL: test_wrong_select_related (known_related_objects.tests.ExistingRelatedInstancesTests.test_wrong_select_related)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n File \"D:\\Work\\django\\tests\\known_related_objects\\tests.py\", line 171, in test_wrong_select_related\n\tself.assertEqual(p[0].pool.tournament, p[0].tournament_pool.tournament)\nAssertionError: <Tournament: Tournament object (1)> != <PoolStyle: PoolStyle object (1)>\n----------------------------------------------------------------------\n", "hints_text": "Seems this bug can be fixed by: M django/db/models/sql/compiler.py @@ -1270,6 +1270,9 @@ class SQLCompiler: if from_obj: final_field.remote_field.set_cached_value(from_obj, obj) + def no_local_setter(obj, from_obj): + pass + def remote_setter(name, obj, from_obj): setattr(from_obj, name, obj) @@ -1291,7 +1294,7 @@ class SQLCompiler: \"model\": model, \"field\": final_field, \"reverse\": True, - \"local_setter\": partial(local_setter, final_field), + \"local_setter\": partial(local_setter, final_field) if len(joins) <= 2 else no_local_setter, \"remote_setter\": partial(remote_setter, name), \"from_parent\": from_parent, }\n\"cyclic\" is not the case. Try the test below: def test_wrong_select_related2(self): with self.assertNumQueries(3): p = list( Tournament.objects.filter(id=self.t2.id).annotate( style=FilteredRelation('pool__another_style'), ).select_related('style') ) self.assertEqual(self.ps3, p[0].style) self.assertEqual(self.p1, p[0].style.pool) self.assertEqual(self.p3, p[0].style.another_pool) result: ====================================================================== FAIL: test_wrong_select_related2 (known_related_objects.tests.ExistingRelatedInstancesTests.test_wrong_select_related2) ---------------------------------------------------------------------- Traceback (most recent call last): File \"/repos/django/tests/known_related_objects/tests.py\", line 186, in test_wrong_select_related2 self.assertEqual(self.p3, p[0].style.another_pool) AssertionError: <Pool: Pool object (3)> != <Tournament: Tournament object (2)> ---------------------------------------------------------------------- The query fetch t2 and ps3, then call remote_setter('style', ps3, t2) and local_setter(t2, ps3). The joins is ['known_related_objects_tournament', 'known_related_objects_pool', 'style']. The type of the first argument of the local_setter should be joins[-2], but query do not fetch that object, so no available local_setter when len(joins) > 2.\n\u200bhttps://github.com/django/django/pull/16408", "created_at": "2022-12-29T02:08:29Z", "version": "5.0", "FAIL_TO_PASS": "[\"test_multilevel_reverse_fk_cyclic_select_related (known_related_objects.tests.ExistingRelatedInstancesTests.test_multilevel_reverse_fk_cyclic_select_related)\", \"test_multilevel_reverse_fk_select_related (known_related_objects.tests.ExistingRelatedInstancesTests.test_multilevel_reverse_fk_select_related)\"]", "PASS_TO_PASS": "[\"test_foreign_key (known_related_objects.tests.ExistingRelatedInstancesTests.test_foreign_key)\", \"test_foreign_key_multiple_prefetch (known_related_objects.tests.ExistingRelatedInstancesTests.test_foreign_key_multiple_prefetch)\", \"test_foreign_key_prefetch_related (known_related_objects.tests.ExistingRelatedInstancesTests.test_foreign_key_prefetch_related)\", \"test_one_to_one (known_related_objects.tests.ExistingRelatedInstancesTests.test_one_to_one)\", \"test_one_to_one_multi_prefetch_related (known_related_objects.tests.ExistingRelatedInstancesTests.test_one_to_one_multi_prefetch_related)\", \"test_one_to_one_multi_select_related (known_related_objects.tests.ExistingRelatedInstancesTests.test_one_to_one_multi_select_related)\", \"test_one_to_one_prefetch_related (known_related_objects.tests.ExistingRelatedInstancesTests.test_one_to_one_prefetch_related)\", \"test_one_to_one_select_related (known_related_objects.tests.ExistingRelatedInstancesTests.test_one_to_one_select_related)\", \"test_queryset_and (known_related_objects.tests.ExistingRelatedInstancesTests.test_queryset_and)\", \"test_queryset_or (known_related_objects.tests.ExistingRelatedInstancesTests.test_queryset_or)\", \"test_queryset_or_different_cached_items (known_related_objects.tests.ExistingRelatedInstancesTests.test_queryset_or_different_cached_items)\", \"test_queryset_or_only_one_with_precache (known_related_objects.tests.ExistingRelatedInstancesTests.test_queryset_or_only_one_with_precache)\", \"test_reverse_fk_select_related_multiple (known_related_objects.tests.ExistingRelatedInstancesTests.test_reverse_fk_select_related_multiple)\", \"test_reverse_one_to_one (known_related_objects.tests.ExistingRelatedInstancesTests.test_reverse_one_to_one)\", \"test_reverse_one_to_one_multi_prefetch_related (known_related_objects.tests.ExistingRelatedInstancesTests.test_reverse_one_to_one_multi_prefetch_related)\", \"test_reverse_one_to_one_multi_select_related (known_related_objects.tests.ExistingRelatedInstancesTests.test_reverse_one_to_one_multi_select_related)\", \"test_reverse_one_to_one_prefetch_related (known_related_objects.tests.ExistingRelatedInstancesTests.test_reverse_one_to_one_prefetch_related)\", \"test_reverse_one_to_one_select_related (known_related_objects.tests.ExistingRelatedInstancesTests.test_reverse_one_to_one_select_related)\"]", "environment_setup_commit": "4a72da71001f154ea60906a2f74898d32b7322a7"}, "On branch main\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   django/db/models/sql/compiler.py\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")\ncommit ef85b6bf0bc5a8b194f0724cf5bbedbcee402b96\nAuthor: Matt Westcott <matt@west.co.tt>\nDate:   Fri Jan 20 18:10:29 2023 +0000\n\n    Fixed #34192 -- Preserved callable storage when it returns default_storage.\n\ndiff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 7a99b12691..04b3eb3473 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -295,8 +295,9 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs[\"upload_to\"] = self.upload_to\n-        if self.storage is not default_storage:\n-            kwargs[\"storage\"] = getattr(self, \"_storage_callable\", self.storage)\n+        storage = getattr(self, \"_storage_callable\", self.storage)\n+        if storage is not default_storage:\n+            kwargs[\"storage\"] = storage\n         return name, path, args, kwargs\n \n     def get_internal_type(self):\ndiff --git a/tests/file_storage/models.py b/tests/file_storage/models.py\nindex 7a60784349..873c3e176a 100644\n--- a/tests/file_storage/models.py\n+++ b/tests/file_storage/models.py\n@@ -9,7 +9,7 @@ import random\n import tempfile\n from pathlib import Path\n \n-from django.core.files.storage import FileSystemStorage\n+from django.core.files.storage import FileSystemStorage, default_storage\n from django.db import models\n \n \n@@ -27,6 +27,10 @@ def callable_storage():\n     return temp_storage\n \n \n+def callable_default_storage():\n+    return default_storage\n+\n+\n class CallableStorage(FileSystemStorage):\n     def __call__(self):\n         # no-op implementation.\n@@ -62,6 +66,9 @@ class Storage(models.Model):\n     storage_callable_class = models.FileField(\n         storage=CallableStorage, upload_to=\"storage_callable_class\"\n     )\n+    storage_callable_default = models.FileField(\n+        storage=callable_default_storage, upload_to=\"storage_callable_default\"\n+    )\n     default = models.FileField(\n         storage=temp_storage, upload_to=\"tests\", default=\"tests/default.txt\"\n     )\ndiff --git a/tests/file_storage/tests.py b/tests/file_storage/tests.py\nindex 4616aad10a..7fb57fbce4 100644\n--- a/tests/file_storage/tests.py\n+++ b/tests/file_storage/tests.py\n@@ -41,7 +41,13 @@ from django.utils import timezone\n from django.utils._os import symlinks_supported\n from django.utils.deprecation import RemovedInDjango51Warning\n \n-from .models import Storage, callable_storage, temp_storage, temp_storage_location\n+from .models import (\n+    Storage,\n+    callable_default_storage,\n+    callable_storage,\n+    temp_storage,\n+    temp_storage_location,\n+)\n \n FILE_SUFFIX_REGEX = \"[A-Za-z0-9]{7}\"\n \n@@ -1018,6 +1024,15 @@ class FieldCallableFileStorageTests(SimpleTestCase):\n         storage = kwargs[\"storage\"]\n         self.assertIs(storage, callable_storage)\n \n+    def test_deconstruction_storage_callable_default(self):\n+        \"\"\"\n+        A callable that returns default_storage is not omitted when\n+        deconstructing.\n+        \"\"\"\n+        obj = Storage()\n+        *_, kwargs = obj._meta.get_field(\"storage_callable_default\").deconstruct()\n+        self.assertIs(kwargs[\"storage\"], callable_default_storage)\n+\n \n # Tests for a race condition on file saving (#4948).\n # This is written in such a way that it'll always pass on platforms\ndiff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 7c433b3f06..c07076d54a 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -1274,6 +1274,9 @@ class SQLCompiler:\n                 if from_obj:\n                     final_field.remote_field.set_cached_value(from_obj, obj)\n \n+            def local_setter_noop(obj, from_obj):\n+                pass\n+\n             def remote_setter(name, obj, from_obj):\n                 setattr(from_obj, name, obj)\n \n@@ -1295,7 +1298,11 @@ class SQLCompiler:\n                         \"model\": model,\n                         \"field\": final_field,\n                         \"reverse\": True,\n-                        \"local_setter\": partial(local_setter, final_field),\n+                        \"local_setter\": (\n+                            partial(local_setter, final_field)\n+                            if len(joins) <= 2\n+                            else local_setter_noop\n+                        ),\n                         \"remote_setter\": partial(remote_setter, name),\n                         \"from_parent\": from_parent,\n                     }\nObtaining file:///testbed\n  Installing build dependencies: started\n  Installing build dependencies: finished with status 'done'\n  Checking if build backend supports build_editable: started\n  Checking if build backend supports build_editable: finished with status 'done'\n  Getting requirements to build editable: started\n  Getting requirements to build editable: finished with status 'done'\n  Preparing editable metadata (pyproject.toml): started\n  Preparing editable metadata (pyproject.toml): finished with status 'done'\nRequirement already satisfied: asgiref>=3.6.0 in /opt/miniconda3/envs/testbed/lib/python3.11/site-packages (from Django==5.0.dev20230123092917) (3.8.1)\nRequirement already satisfied: sqlparse>=0.2.2 in /opt/miniconda3/envs/testbed/lib/python3.11/site-packages (from Django==5.0.dev20230123092917) (0.5.1)\nBuilding wheels for collected packages: Django\n  Building editable for Django (pyproject.toml): started\n  Building editable for Django (pyproject.toml): finished with status 'done'\n  Created wheel for Django: filename=Django-5.0.dev20230123092917-0.editable-py3-none-any.whl size=27303 sha256=b8a68315e438d5558c440d17102d192bc54352318b515fd6067dbf17df32e364\n  Stored in directory: /tmp/pip-ephem-wheel-cache-9wf3ht6l/wheels/49/5f/4f/01b7d31ea6ddac9643da788242d33e5fd3467d95d17b032c6b\nSuccessfully built Django\nInstalling collected packages: Django\n  Attempting uninstall: Django\n    Found existing installation: Django 5.0.dev20230123092917\n    Uninstalling Django-5.0.dev20230123092917:\n      Successfully uninstalled Django-5.0.dev20230123092917\nSuccessfully installed Django-5.0.dev20230123092917\nTesting against Django installed in '/testbed/django'\nImporting application known_related_objects\nFound 20 test(s).\nSkipping setup of unused database(s): other.\nOperations to perform:\n  Synchronize unmigrated apps: auth, contenttypes, known_related_objects, messages, sessions, staticfiles\n  Apply all migrations: admin, sites\nSynchronizing apps without migrations:\n  Creating tables...\n    Creating table django_content_type\n    Creating table auth_permission\n    Creating table auth_group\n    Creating table auth_user\n    Creating table django_session\n    Creating table known_related_objects_tournament\n    Creating table known_related_objects_organiser\n    Creating table known_related_objects_pool\n    Creating table known_related_objects_poolstyle\n    Running deferred SQL...\nRunning migrations:\n  Applying admin.0001_initial... OK\n  Applying admin.0002_logentry_remove_auto_add... OK\n  Applying admin.0003_logentry_add_action_flag_choices... OK\n  Applying sites.0001_initial... OK\n  Applying sites.0002_alter_domain_unique... OK\nSystem check identified no issues (0 silenced).\n", {}]