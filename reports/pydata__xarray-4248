[{"repo": "pydata/xarray", "instance_id": "pydata__xarray-4248", "base_commit": "98dc1f4ea18738492e074e9e51ddfed5cd30ab94", "patch": "diff --git a/xarray/core/formatting.py b/xarray/core/formatting.py\n--- a/xarray/core/formatting.py\n+++ b/xarray/core/formatting.py\n@@ -261,6 +261,8 @@ def inline_variable_array_repr(var, max_width):\n         return inline_dask_repr(var.data)\n     elif isinstance(var._data, sparse_array_type):\n         return inline_sparse_repr(var.data)\n+    elif hasattr(var._data, \"_repr_inline_\"):\n+        return var._data._repr_inline_(max_width)\n     elif hasattr(var._data, \"__array_function__\"):\n         return maybe_truncate(repr(var._data).replace(\"\\n\", \" \"), max_width)\n     else:\n", "test_patch": "diff --git a/xarray/tests/test_formatting.py b/xarray/tests/test_formatting.py\n--- a/xarray/tests/test_formatting.py\n+++ b/xarray/tests/test_formatting.py\n@@ -7,6 +7,7 @@\n \n import xarray as xr\n from xarray.core import formatting\n+from xarray.core.npcompat import IS_NEP18_ACTIVE\n \n from . import raises_regex\n \n@@ -391,6 +392,44 @@ def test_array_repr(self):\n         assert actual == expected\n \n \n+@pytest.mark.skipif(not IS_NEP18_ACTIVE, reason=\"requires __array_function__\")\n+def test_inline_variable_array_repr_custom_repr():\n+    class CustomArray:\n+        def __init__(self, value, attr):\n+            self.value = value\n+            self.attr = attr\n+\n+        def _repr_inline_(self, width):\n+            formatted = f\"({self.attr}) {self.value}\"\n+            if len(formatted) > width:\n+                formatted = f\"({self.attr}) ...\"\n+\n+            return formatted\n+\n+        def __array_function__(self, *args, **kwargs):\n+            return NotImplemented\n+\n+        @property\n+        def shape(self):\n+            return self.value.shape\n+\n+        @property\n+        def dtype(self):\n+            return self.value.dtype\n+\n+        @property\n+        def ndim(self):\n+            return self.value.ndim\n+\n+    value = CustomArray(np.array([20, 40]), \"m\")\n+    variable = xr.Variable(\"x\", value)\n+\n+    max_width = 10\n+    actual = formatting.inline_variable_array_repr(variable, max_width=10)\n+\n+    assert actual == value._repr_inline_(max_width)\n+\n+\n def test_set_numpy_options():\n     original_options = np.get_printoptions()\n     with formatting.set_numpy_options(threshold=10):\n", "problem_statement": "Feature request: show units in dataset overview\nHere's a hypothetical dataset:\r\n\r\n```\r\n<xarray.Dataset>\r\nDimensions:  (time: 3, x: 988, y: 822)\r\nCoordinates:\r\n  * x         (x) float64 ...\r\n  * y         (y) float64 ...\r\n  * time      (time) datetime64[ns] ...\r\nData variables:\r\n    rainfall  (time, y, x) float32 ...\r\n    max_temp  (time, y, x) float32 ...\r\n```\r\n\r\nIt would be really nice if the units of the coordinates and of the data variables were shown in the `Dataset` repr, for example as:\r\n\r\n```\r\n<xarray.Dataset>\r\nDimensions:  (time: 3, x: 988, y: 822)\r\nCoordinates:\r\n  * x, in metres         (x)            float64 ...\r\n  * y, in metres         (y)            float64 ...\r\n  * time                 (time)         datetime64[ns] ...\r\nData variables:\r\n    rainfall, in mm      (time, y, x)   float32 ...\r\n    max_temp, in deg C   (time, y, x)   float32 ...\r\n```\n", "hints_text": "I would love to see this.\r\n\r\nWhat would we want the exact formatting to be? Square brackets to copy how units from `attrs['units']` are displayed on plots? e.g.\r\n```\r\n<xarray.Dataset>\r\nDimensions:  (time: 3, x: 988, y: 822)\r\nCoordinates:\r\n  * x [m]             (x)            float64 ...\r\n  * y [m]             (y)            float64 ...\r\n  * time [s]          (time)         datetime64[ns] ...\r\nData variables:\r\n    rainfall [mm]     (time, y, x)   float32 ...\r\n    max_temp [deg C]  (time, y, x)   float32 ...\r\n```\r\nThe lack of vertical alignment is kind of ugly...\r\n\r\nThere are now two cases to discuss: units in `attrs`, and unit-aware arrays like pint. (If we do the latter we may not need the former though...)\r\n\r\nfrom @keewis on #3616:\r\n\r\n>At the moment, the formatting.diff_*_repr functions that provide the pretty-printing for assert_* use repr to format NEP-18 strings, truncating the result if it is too long. In the case of pint's quantities, this makes the pretty printing useless since only a few values are visible and the unit is in the truncated part.\r\n>\r\n> What should we about this? Does pint have to change its repr?\r\n\r\nWe could presumably just extract the units from pint's repr to display them separately. I don't know if that raises questions about generality of duck-typing arrays though @dcherian ? Is it fine to make units a special-case?\nit was argued in pint that the unit is part of the data, so we should keep it as close to the data as possible. How about\r\n```\r\n<xarray.Dataset>\r\nDimensions:  (time: 3, x: 988, y: 822)\r\nCoordinates:\r\n  * x             (x)          [m]     float64 ...\r\n  * y             (y)          [m]     float64 ...\r\n  * time          (time)       [s]     datetime64[ns] ...\r\nData variables:\r\n    rainfall      (time, y, x) [mm]    float32 ...\r\n    max_temp      (time, y, x) [deg C] float32 ...\r\n```\r\nor\r\n```\r\n<xarray.Dataset>\r\nDimensions:  (time: 3, x: 988, y: 822)\r\nCoordinates:\r\n  * x             (x)             float64 [m] ...\r\n  * y             (y)             float64 [m] ...\r\n  * time          (time)          datetime64[ns] [s] ...\r\nData variables:\r\n    rainfall      (time, y, x)    float32 [mm] ...\r\n    max_temp      (time, y, x)    float32 [deg C] ...\r\n```\r\nThe issue with the second example is that it is easy to confuse with numpy's dtype, though. Maybe we should use parentheses instead?\r\n\r\nre special casing: I think would be fine for attributes since we already special case them for plotting, but I don't know about duck arrays. Even if we want to special case them, there are many unit libraries with different interfaces so we would either need to special case all of them or require a specific interface (or a function to retrieve the necessary data?).\r\n\r\nAlso, we should keep in mind is that using more horizontal space for the units results in less space for data. And we should not forget about https://github.com/dask/dask/issues/5329#issue-485927396, where a different kind of format was proposed, at least for the values of a `DataArray`.\nInstead of trying to come up with our own formatting, how about supporting a `_repr_short_(self, length)` method on the duck array (with a fall back to the current behavior)? That way duck arrays have to explicitly define the format (or have a compatibility package like `pint-xarray` provide it for them) if they want something different from their normal repr and we don't have to add duck array specific code.\r\n\r\nThis won't help with displaying the `units` attributes (which we don't really need once we have support for pint arrays in indexes).", "created_at": "2020-07-22T14:54:03Z", "version": "0.12", "FAIL_TO_PASS": "[\"xarray/tests/test_formatting.py::test_inline_variable_array_repr_custom_repr\"]", "PASS_TO_PASS": "[\"xarray/tests/test_formatting.py::TestFormatting::test_get_indexer_at_least_n_items\", \"xarray/tests/test_formatting.py::TestFormatting::test_first_n_items\", \"xarray/tests/test_formatting.py::TestFormatting::test_last_n_items\", \"xarray/tests/test_formatting.py::TestFormatting::test_last_item\", \"xarray/tests/test_formatting.py::TestFormatting::test_format_item\", \"xarray/tests/test_formatting.py::TestFormatting::test_format_items\", \"xarray/tests/test_formatting.py::TestFormatting::test_format_array_flat\", \"xarray/tests/test_formatting.py::TestFormatting::test_pretty_print\", \"xarray/tests/test_formatting.py::TestFormatting::test_maybe_truncate\", \"xarray/tests/test_formatting.py::TestFormatting::test_format_timestamp_out_of_bounds\", \"xarray/tests/test_formatting.py::TestFormatting::test_attribute_repr\", \"xarray/tests/test_formatting.py::TestFormatting::test_diff_array_repr\", \"xarray/tests/test_formatting.py::TestFormatting::test_diff_attrs_repr_with_array\", \"xarray/tests/test_formatting.py::TestFormatting::test_diff_dataset_repr\", \"xarray/tests/test_formatting.py::TestFormatting::test_array_repr\", \"xarray/tests/test_formatting.py::test_set_numpy_options\", \"xarray/tests/test_formatting.py::test_short_numpy_repr\", \"xarray/tests/test_formatting.py::test_large_array_repr_length\"]", "environment_setup_commit": "1c198a191127c601d091213c4b3292a8bb3054e1"}, "On branch main\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   xarray/core/formatting.py\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")\ncommit 98dc1f4ea18738492e074e9e51ddfed5cd30ab94\nAuthor: keewis <keewis@users.noreply.github.com>\nDate:   Wed Aug 5 23:31:45 2020 +0200\n\n    silence the known docs CI issues (#4316)\n    \n    * pin pandas to 1.0\n    \n    * remove the removed datastore properties from api-hidden.rst\n    \n    * remove the removed DataStore methods inherited from dict from api-hidden\n\ndiff --git a/ci/requirements/doc.yml b/ci/requirements/doc.yml\nindex 6caebc46..e24adddf 100644\n--- a/ci/requirements/doc.yml\n+++ b/ci/requirements/doc.yml\n@@ -17,7 +17,9 @@ dependencies:\n   - netcdf4>=1.5\n   - numba\n   - numpy>=1.17\n-  - pandas>=1.0\n+  # FIXME https://github.com/pydata/xarray/issues/4287\n+  # - pandas>=1.0\n+  - pandas=1.0\n   - rasterio>=1.1\n   - seaborn\n   - setuptools\ndiff --git a/doc/api-hidden.rst b/doc/api-hidden.rst\nindex efef4259..6aca9086 100644\n--- a/doc/api-hidden.rst\n+++ b/doc/api-hidden.rst\n@@ -665,13 +665,10 @@\n    backends.NetCDF4DataStore.encode\n    backends.NetCDF4DataStore.encode_attribute\n    backends.NetCDF4DataStore.encode_variable\n-   backends.NetCDF4DataStore.get\n    backends.NetCDF4DataStore.get_attrs\n    backends.NetCDF4DataStore.get_dimensions\n    backends.NetCDF4DataStore.get_encoding\n    backends.NetCDF4DataStore.get_variables\n-   backends.NetCDF4DataStore.items\n-   backends.NetCDF4DataStore.keys\n    backends.NetCDF4DataStore.load\n    backends.NetCDF4DataStore.open\n    backends.NetCDF4DataStore.open_store_variable\n@@ -685,27 +682,20 @@\n    backends.NetCDF4DataStore.store\n    backends.NetCDF4DataStore.store_dataset\n    backends.NetCDF4DataStore.sync\n-   backends.NetCDF4DataStore.values\n-   backends.NetCDF4DataStore.attrs\n    backends.NetCDF4DataStore.autoclose\n-   backends.NetCDF4DataStore.dimensions\n    backends.NetCDF4DataStore.ds\n    backends.NetCDF4DataStore.format\n    backends.NetCDF4DataStore.is_remote\n    backends.NetCDF4DataStore.lock\n-   backends.NetCDF4DataStore.variables\n \n    backends.H5NetCDFStore.close\n    backends.H5NetCDFStore.encode\n    backends.H5NetCDFStore.encode_attribute\n    backends.H5NetCDFStore.encode_variable\n-   backends.H5NetCDFStore.get\n    backends.H5NetCDFStore.get_attrs\n    backends.H5NetCDFStore.get_dimensions\n    backends.H5NetCDFStore.get_encoding\n    backends.H5NetCDFStore.get_variables\n-   backends.H5NetCDFStore.items\n-   backends.H5NetCDFStore.keys\n    backends.H5NetCDFStore.load\n    backends.H5NetCDFStore.open_store_variable\n    backends.H5NetCDFStore.prepare_variable\n@@ -718,39 +708,25 @@\n    backends.H5NetCDFStore.store\n    backends.H5NetCDFStore.store_dataset\n    backends.H5NetCDFStore.sync\n-   backends.H5NetCDFStore.values\n-   backends.H5NetCDFStore.attrs\n-   backends.H5NetCDFStore.dimensions\n    backends.H5NetCDFStore.ds\n-   backends.H5NetCDFStore.variables\n \n    backends.PydapDataStore.close\n-   backends.PydapDataStore.get\n    backends.PydapDataStore.get_attrs\n    backends.PydapDataStore.get_dimensions\n    backends.PydapDataStore.get_encoding\n    backends.PydapDataStore.get_variables\n-   backends.PydapDataStore.items\n-   backends.PydapDataStore.keys\n    backends.PydapDataStore.load\n    backends.PydapDataStore.open\n    backends.PydapDataStore.open_store_variable\n-   backends.PydapDataStore.values\n-   backends.PydapDataStore.attrs\n-   backends.PydapDataStore.dimensions\n-   backends.PydapDataStore.variables\n \n    backends.ScipyDataStore.close\n    backends.ScipyDataStore.encode\n    backends.ScipyDataStore.encode_attribute\n    backends.ScipyDataStore.encode_variable\n-   backends.ScipyDataStore.get\n    backends.ScipyDataStore.get_attrs\n    backends.ScipyDataStore.get_dimensions\n    backends.ScipyDataStore.get_encoding\n    backends.ScipyDataStore.get_variables\n-   backends.ScipyDataStore.items\n-   backends.ScipyDataStore.keys\n    backends.ScipyDataStore.load\n    backends.ScipyDataStore.open_store_variable\n    backends.ScipyDataStore.prepare_variable\n@@ -763,11 +739,7 @@\n    backends.ScipyDataStore.store\n    backends.ScipyDataStore.store_dataset\n    backends.ScipyDataStore.sync\n-   backends.ScipyDataStore.values\n-   backends.ScipyDataStore.attrs\n-   backends.ScipyDataStore.dimensions\n    backends.ScipyDataStore.ds\n-   backends.ScipyDataStore.variables\n \n    backends.FileManager.acquire\n    backends.FileManager.acquire_context\ndiff --git a/xarray/core/formatting.py b/xarray/core/formatting.py\nindex 28eaae5f..9aa20f2b 100644\n--- a/xarray/core/formatting.py\n+++ b/xarray/core/formatting.py\n@@ -261,6 +261,8 @@ def inline_variable_array_repr(var, max_width):\n         return inline_dask_repr(var.data)\n     elif isinstance(var._data, sparse_array_type):\n         return inline_sparse_repr(var.data)\n+    elif hasattr(var._data, \"_repr_inline_\"):\n+        return var._data._repr_inline_(max_width)\n     elif hasattr(var._data, \"__array_function__\"):\n         return maybe_truncate(repr(var._data).replace(\"\\n\", \" \"), max_width)\n     else:\nObtaining file:///testbed\n  Preparing metadata (setup.py): started\n  Preparing metadata (setup.py): finished with status 'done'\nRequirement already satisfied: numpy>=1.15 in /opt/miniconda3/envs/testbed/lib/python3.10/site-packages (from xarray==0.16.1.dev27+g98dc1f4e.d20220101) (1.23.0)\nRequirement already satisfied: pandas>=0.25 in /opt/miniconda3/envs/testbed/lib/python3.10/site-packages (from xarray==0.16.1.dev27+g98dc1f4e.d20220101) (1.5.3)\nRequirement already satisfied: setuptools>=41.2 in /opt/miniconda3/envs/testbed/lib/python3.10/site-packages (from xarray==0.16.1.dev27+g98dc1f4e.d20220101) (68.0.0)\nRequirement already satisfied: python-dateutil>=2.8.1 in /opt/miniconda3/envs/testbed/lib/python3.10/site-packages (from pandas>=0.25->xarray==0.16.1.dev27+g98dc1f4e.d20220101) (2.8.2)\nRequirement already satisfied: pytz>=2020.1 in /opt/miniconda3/envs/testbed/lib/python3.10/site-packages (from pandas>=0.25->xarray==0.16.1.dev27+g98dc1f4e.d20220101) (2023.3)\nRequirement already satisfied: six>=1.5 in /opt/miniconda3/envs/testbed/lib/python3.10/site-packages (from python-dateutil>=2.8.1->pandas>=0.25->xarray==0.16.1.dev27+g98dc1f4e.d20220101) (1.16.0)\nInstalling collected packages: xarray\n  Attempting uninstall: xarray\n    Found existing installation: xarray 0.16.1.dev27+g98dc1f4e\n    Uninstalling xarray-0.16.1.dev27+g98dc1f4e:\n      Successfully uninstalled xarray-0.16.1.dev27+g98dc1f4e\n  Running setup.py develop for xarray\nSuccessfully installed xarray\n============================= test session starts ==============================\nplatform linux -- Python 3.10.15, pytest-7.4.0, pluggy-1.5.0\nrootdir: /testbed\nconfigfile: setup.cfg\nplugins: hypothesis-6.112.4, cov-5.0.0, env-1.1.5, xdist-3.6.1\ncollected 19 items\n\nxarray/tests/test_formatting.py ...................                      [100%]\n\n=============================== warnings summary ===============================\nxarray/__init__.py:1\n  /testbed/xarray/__init__.py:1: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html\n    import pkg_resources\n\nxarray/core/dask_array_compat.py:16\nxarray/core/dask_array_compat.py:16\n  /testbed/xarray/core/dask_array_compat.py:16: DeprecationWarning: distutils Version classes are deprecated. Use packaging.version instead.\n    if LooseVersion(dask_version) >= LooseVersion(\"2.0.0\"):\n\nxarray/core/dask_array_compat.py:149\nxarray/core/dask_array_compat.py:149\n  /testbed/xarray/core/dask_array_compat.py:149: DeprecationWarning: distutils Version classes are deprecated. Use packaging.version instead.\n    if LooseVersion(dask_version) >= LooseVersion(\"2.8.1\"):\n\nxarray/core/dask_array_compat.py:186\nxarray/core/dask_array_compat.py:186\n  /testbed/xarray/core/dask_array_compat.py:186: DeprecationWarning: distutils Version classes are deprecated. Use packaging.version instead.\n    if LooseVersion(dask_version) > LooseVersion(\"2.9.0\"):\n\nxarray/core/pdcompat.py:45\n  /testbed/xarray/core/pdcompat.py:45: DeprecationWarning: distutils Version classes are deprecated. Use packaging.version instead.\n    if LooseVersion(pd.__version__) < \"0.25.0\":\n\n../opt/miniconda3/envs/testbed/lib/python3.10/site-packages/setuptools/_distutils/version.py:345\n  /opt/miniconda3/envs/testbed/lib/python3.10/site-packages/setuptools/_distutils/version.py:345: DeprecationWarning: distutils Version classes are deprecated. Use packaging.version instead.\n    other = LooseVersion(other)\n\nxarray/tests/__init__.py:58\nxarray/tests/__init__.py:58\n  /testbed/xarray/tests/__init__.py:58: DeprecationWarning: distutils Version classes are deprecated. Use packaging.version instead.\n    return version.LooseVersion(vstring)\n\n-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html\n==================================== PASSES ====================================\n=========================== short test summary info ============================\nPASSED xarray/tests/test_formatting.py::TestFormatting::test_get_indexer_at_least_n_items\nPASSED xarray/tests/test_formatting.py::TestFormatting::test_first_n_items\nPASSED xarray/tests/test_formatting.py::TestFormatting::test_last_n_items\nPASSED xarray/tests/test_formatting.py::TestFormatting::test_last_item\nPASSED xarray/tests/test_formatting.py::TestFormatting::test_format_item\nPASSED xarray/tests/test_formatting.py::TestFormatting::test_format_items\nPASSED xarray/tests/test_formatting.py::TestFormatting::test_format_array_flat\nPASSED xarray/tests/test_formatting.py::TestFormatting::test_pretty_print\nPASSED xarray/tests/test_formatting.py::TestFormatting::test_maybe_truncate\nPASSED xarray/tests/test_formatting.py::TestFormatting::test_format_timestamp_out_of_bounds\nPASSED xarray/tests/test_formatting.py::TestFormatting::test_attribute_repr\nPASSED xarray/tests/test_formatting.py::TestFormatting::test_diff_array_repr\nPASSED xarray/tests/test_formatting.py::TestFormatting::test_diff_attrs_repr_with_array\nPASSED xarray/tests/test_formatting.py::TestFormatting::test_diff_dataset_repr\nPASSED xarray/tests/test_formatting.py::TestFormatting::test_array_repr\nPASSED xarray/tests/test_formatting.py::test_inline_variable_array_repr_custom_repr\nPASSED xarray/tests/test_formatting.py::test_set_numpy_options\nPASSED xarray/tests/test_formatting.py::test_short_numpy_repr\nPASSED xarray/tests/test_formatting.py::test_large_array_repr_length\n======================= 19 passed, 11 warnings in 4.06s ========================\n", {"xarray/tests/test_formatting.py::TestFormatting::test_get_indexer_at_least_n_items": "PASSED", "xarray/tests/test_formatting.py::TestFormatting::test_first_n_items": "PASSED", "xarray/tests/test_formatting.py::TestFormatting::test_last_n_items": "PASSED", "xarray/tests/test_formatting.py::TestFormatting::test_last_item": "PASSED", "xarray/tests/test_formatting.py::TestFormatting::test_format_item": "PASSED", "xarray/tests/test_formatting.py::TestFormatting::test_format_items": "PASSED", "xarray/tests/test_formatting.py::TestFormatting::test_format_array_flat": "PASSED", "xarray/tests/test_formatting.py::TestFormatting::test_pretty_print": "PASSED", "xarray/tests/test_formatting.py::TestFormatting::test_maybe_truncate": "PASSED", "xarray/tests/test_formatting.py::TestFormatting::test_format_timestamp_out_of_bounds": "PASSED", "xarray/tests/test_formatting.py::TestFormatting::test_attribute_repr": "PASSED", "xarray/tests/test_formatting.py::TestFormatting::test_diff_array_repr": "PASSED", "xarray/tests/test_formatting.py::TestFormatting::test_diff_attrs_repr_with_array": "PASSED", "xarray/tests/test_formatting.py::TestFormatting::test_diff_dataset_repr": "PASSED", "xarray/tests/test_formatting.py::TestFormatting::test_array_repr": "PASSED", "xarray/tests/test_formatting.py::test_inline_variable_array_repr_custom_repr": "PASSED", "xarray/tests/test_formatting.py::test_set_numpy_options": "PASSED", "xarray/tests/test_formatting.py::test_short_numpy_repr": "PASSED", "xarray/tests/test_formatting.py::test_large_array_repr_length": "PASSED"}]